<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo de Testes - Corre√ß√£o Automatizada</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß™</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 40px;
        }

        /* Timeline Multi-Step */
        .timeline {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 20px;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            z-index: 0;
        }

        .timelineStep {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .timelineCircle {
            width: 40px;
            height: 40px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .timelineStep.active .timelineCircle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .timelineStep.completed .timelineCircle {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .timelineLabel {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }

        /* Seletor de Teste */
        .testSelector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .testCard {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .testCard:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .testCard.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .testCard h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .testCard p {
            color: #666;
            font-size: 14px;
        }

        /* Formul√°rios */
        .formSection {
            display: none;
        }

        .formSection.active {
            display: block;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .campo-preenchido-ia {
            background-color: #e8f5e8 !important;
            border-color: #28a745 !important;
        }

        .campo-verificar-ia {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Bot√µes */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .buttonGroup {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        /* Resultados */
        .resultBox {
            background: #f5f7fa;
            padding: 20px;
            border-left: 4px solid #667eea;
            border-radius: 5px;
            margin: 15px 0;
        }

        .resultBox.highlight {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left-color: #764ba2;
        }

        .resultValue {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .resultLabel {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Upload de Imagem */
        .imageUploadArea {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .imageUploadArea:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .imageUploadArea.dragover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }

        .analysisPreviewLayout {
            display: none;
            gap: 25px;
            margin-top: 25px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
        }

        .analysisPreviewColumn {
            flex: 1 1 320px;
            max-width: 480px;
        }

        .analysisPreviewColumn h4 {
            margin-bottom: 12px;
            color: #3949ab;
            font-size: 16px;
        }

        .analysisPreviewImage,
        #analysisOverlayCanvas {
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
            display: block;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .analysisPreviewImage {
            border: 1px solid #d1d9ff;
            background: #fff;
        }

        #analysisOverlayCanvas {
            border: 2px solid #667eea;
            background: #fff;
        }

        .annotationLegend {
            margin-top: 15px;
            font-size: 13px;
            color: #394455;
            background: #f5f7fa;
            border: 1px solid #dfe3f5;
            border-radius: 10px;
            padding: 12px 15px;
            line-height: 1.5;
        }

        .imagePreview {
            max-width: 100%;
            max-height: 400px;
            margin-top: 20px;
            border-radius: 8px;
        }

        /* Tabelas Normativas */
        .tableContainer {
            overflow-x: auto;
            margin: 20px 0;
        }

        .normativeTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .normativeTable th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .normativeTable td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .normativeTable tr:hover {
            background: #f5f7fa;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .timeline {
                flex-direction: column;
            }
            
            .timeline::before {
                left: 20px;
                top: 0;
                width: 2px;
                height: 100%;
            }
            
            .timelineStep {
                margin-bottom: 30px;
                text-align: left;
                padding-left: 60px;
            }
            
            .timelineCircle {
                position: absolute;
                left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ M√≥dulo de Corre√ß√£o de Testes</h1>
            <p>Sistema automatizado de corre√ß√£o e interpreta√ß√£o</p>
        </div>

        <div class="content">
            <!-- Timeline -->
            <div class="timeline">
                <div class="timelineStep" id="step1">
                    <div class="timelineCircle">1</div>
                    <div class="timelineLabel">Selecionar Teste</div>
                </div>
                <div class="timelineStep" id="step2">
                    <div class="timelineCircle">2</div>
                    <div class="timelineLabel">Inserir Dados</div>
                </div>
                <div class="timelineStep" id="step3">
                    <div class="timelineCircle">3</div>
                    <div class="timelineLabel">Tabela Normativa</div>
                </div>
                <div class="timelineStep" id="step4">
                    <div class="timelineCircle">4</div>
                    <div class="timelineLabel">Resultado</div>
                </div>
            </div>

            <!-- Step 1: Sele√ß√£o de Teste -->
            <div class="formSection active" id="section1">
                <h2>Selecione o Teste</h2>
                <div class="testSelector">
                    <div class="testCard" data-test="ac">
                        <h3>üìä Teste AC</h3>
                        <p>Aten√ß√£o Concentrada<br>Acertos, Erros, Omiss√µes</p>
                    </div>
                    <div class="testCard" data-test="beta-iii">
                        <h3>üß© BETA-III</h3>
                        <p>Racioc√≠nio Matricial<br>0-25 acertos</p>
                    </div>
                    <div class="testCard" data-test="bpa2">
                        <h3>üëÅÔ∏è BPA-2</h3>
                        <p>Aten√ß√£o<br>Alternada, Concentrada, Dividida</p>
                    </div>
                    <div class="testCard" data-test="rotas">
                        <h3>üõ£Ô∏è Rotas de Aten√ß√£o</h3>
                        <p>Rotas A, D e C</p>
                    </div>
                    <div class="testCard" data-test="memore">
                        <h3>üß† MEMORE</h3>
                        <p>Mem√≥ria<br>VP, VN, FP, FN</p>
                    </div>
                    <div class="testCard" data-test="mig">
                        <h3>üî¢ MIG</h3>
                        <p>Avalia√ß√£o Psicol√≥gica<br>28 quest√µes</p>
                    </div>
                    <div class="testCard" data-test="mvt">
                        <h3>üöó MVT</h3>
                        <p>Mem√≥ria Visual Tr√¢nsito<br>Acertos, Erros, Omiss√£o</p>
                    </div>
                    <div class="testCard" data-test="r1">
                        <h3>üí≠ R-1</h3>
                        <p>Racioc√≠nio<br>0-40 acertos</p>
                    </div>
                    <div class="testCard" data-test="palografico">
                        <h3>‚úçÔ∏è Palogr√°fico</h3>
                        <p>Roteiro Completo<br>13 vari√°veis quantitativas</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: Inser√ß√£o de Dados -->
            <div class="formSection" id="section2">
                <h2>Inserir Dados do Teste</h2>
                <p>Escolha o m√©todo de entrada:</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <button class="btn" onclick="setInputMethod('manual')">
                        ‚úèÔ∏è Entrada Manual
                    </button>
                    <button class="btn" onclick="setInputMethod('imagem')">
                        üì∑ Analisar Imagem (IA)
                    </button>
                </div>

                <!-- Formul√°rio Manual -->
                <div id="manualForm" style="display: none;">
                    <!-- AC Form -->
                    <div id="acFormManual" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Acertos (A):</label>
                                <input type="number" id="acertos" min="0" value="147">
                            </div>
                            <div class="form-group">
                                <label>Erros (E):</label>
                                <input type="number" id="erros" min="0" value="1">
                            </div>
                            <div class="form-group">
                                <label>Omiss√µes (O):</label>
                                <input type="number" id="omissoes" min="0" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Regi√£o:</label>
                                <select id="acRegiao">
                                    <option value="">Selecione</option>
                                    <option value="Sul">Sul</option>
                                    <option value="Sudeste" selected>Sudeste</option>
                                    <option value="Centro-oeste">Centro-Oeste</option>
                                    <option value="Nordeste">Nordeste</option>
                                    <option value="Norte">Norte</option>
                                    <option value="Geral">Geral</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Escolaridade:</label>
                                <select id="acEscolaridade">
                                    <option value="Total">Total</option>
                                    <option value="Ensino Fundamental">Ensino Fundamental</option>
                                    <option value="Ensino M√©dio">Ensino M√©dio</option>
                                    <option value="Ensino Superior" selected>Ensino Superior</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Idade:</label>
                                <input type="number" id="acIdade" min="18" max="64" placeholder="26">
                            </div>
                        </div>
                    </div>

                    <!-- Palogr√°fico Form -->
                    <div id="palograficoFormManual" style="display: none;">
                        <!-- Modo de An√°lise -->
                        <div style="background: #f0f4ff; border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">üìã Modo de An√°lise</h3>
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="palograficoModo" value="manual" checked style="margin-right: 8px;">
                                    <span>üìù Entrada Manual (Roteiro Completo)</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="palograficoModo" value="ia" style="margin-right: 8px;">
                                    <span>ü§ñ An√°lise por IA (Upload de Imagem)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Se√ß√£o: Entrada Manual -->
                        <div id="palograficoManual" style="display: block;">
                            <h3 style="color: #667eea; margin-bottom: 20px;">üìù Roteiro Completo - Entrada Manual</h3>
                            
                            <!-- 1. Produtividade e NOR -->
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 15px;">1. Produtividade e NOR</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Palos por Minuto 1:</label>
                                        <input type="number" id="tempo1" min="0" value="0" placeholder="Ex: 150">
                                    </div>
                                    <div class="form-group">
                                        <label>Palos por Minuto 2:</label>
                                        <input type="number" id="tempo2" min="0" value="0" placeholder="Ex: 152">
                                    </div>
                                    <div class="form-group">
                                        <label>Palos por Minuto 3:</label>
                                        <input type="number" id="tempo3" min="0" value="0" placeholder="Ex: 148">
                                    </div>
                                    <div class="form-group">
                                        <label>Palos por Minuto 4:</label>
                                        <input type="number" id="tempo4" min="0" value="0" placeholder="Ex: 151">
                                    </div>
                                    <div class="form-group">
                                        <label>Palos por Minuto 5:</label>
                                        <input type="number" id="tempo5" min="0" value="0" placeholder="Ex: 149">
                                    </div>
                                </div>
                                <div class="form-row" style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label>Produtividade Total (calculado automaticamente ou informe):</label>
                                        <input type="number" id="produtividade" min="0" placeholder="Ser√° calculado automaticamente">
                                    </div>
                                    <div class="form-group">
                                        <label>NOR - N√≠vel Oscila√ß√£o R√≠tmica (calculado automaticamente ou informe):</label>
                                        <input type="number" id="nor" step="0.1" placeholder="Ser√° calculado automaticamente">
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Tamanho dos Palos -->
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 15px;">2. Tamanho dos Palos (mm)</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Maiores Palos (separados por v√≠rgula):</label>
                                        <input type="text" id="tamanhosMaiores" placeholder="Ex: 12.5, 13.0, 12.8, 13.2, 12.9">
                                        <small style="color: #666;">Medir os 5 maiores palos em mm</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Menores Palos (separados por v√≠rgula):</label>
                                        <input type="text" id="tamanhosMenores" placeholder="Ex: 8.5, 8.8, 8.6, 8.9, 8.7">
                                        <small style="color: #666;">Medir os 5 menores palos em mm</small>
                                    </div>
                                </div>
                                <div class="form-row" style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label>M√©dia Tamanho Palos (calculado automaticamente ou informe):</label>
                                        <input type="number" id="mediaTamanhoPalos" step="0.1" placeholder="Ser√° calculado automaticamente">
                                    </div>
                                </div>
                            </div>

                            <!-- 3. Dist√¢ncia entre Palos -->
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 15px;">3. Dist√¢ncia entre Palos (mm)</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Dist√¢ncia Total Percorrida (mm):</label>
                                        <input type="number" id="distanciaTotal" step="0.01" placeholder="Ex: 2500.00">
                                    </div>
                                    <div class="form-group">
                                        <label>Dist√¢ncia M√©dia (calculado automaticamente ou informe):</label>
                                        <input type="number" id="distanciaMedia" step="0.01" placeholder="Ser√° calculado automaticamente">
                                    </div>
                                </div>
                            </div>

                            <!-- 4. Impulsividade -->
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 15px;">4. Impulsividade (mm)</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Impulsividade (diferen√ßa entre maior e menor palo):</label>
                                        <input type="number" id="impulsividade" step="0.1" placeholder="Ex: 4.7">
                                        <small style="color: #666;">Maior palo - Menor palo</small>
                                    </div>
                                </div>
                            </div>

                            <!-- 5. Dist√¢ncia entre Linhas -->
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 15px;">5. Dist√¢ncia entre Linhas (mm)</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>M√©dia Dist√¢ncia entre Linhas:</label>
                                        <input type="number" id="mediaDistanciaLinhas" step="0.01" placeholder="Ex: 8.0">
                                    </div>
                                </div>
                            </div>

                            <!-- 6. Margens -->
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 15px;">6. Margens (mm)</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>M√©dia Margem Esquerda:</label>
                                        <input type="number" id="mediaMargemEsquerda" step="0.01" placeholder="Ex: 20.0">
                                    </div>
                                    <div class="form-group">
                                        <label>M√©dia Margem Direita:</label>
                                        <input type="number" id="mediaMargemDireita" step="0.01" placeholder="Ex: 15.0">
                                    </div>
                                    <div class="form-group">
                                        <label>M√©dia Margem Superior:</label>
                                        <input type="number" id="mediaMargemSuperior" step="0.01" placeholder="Ex: 25.0">
                                    </div>
                                </div>
                            </div>

                            <!-- 7. Porcentagem de Ganchos -->
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 15px;">7. Porcentagem de Ganchos (%)</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Porcentagem de Ganchos:</label>
                                        <input type="number" id="porcentagemGanchos" step="0.1" min="0" max="100" placeholder="Ex: 5.2">
                                        <small style="color: #666;">(N√∫mero de palos com ganchos / Total de palos) √ó 100</small>
                                    </div>
                                </div>
                            </div>

                            <!-- 8. Inclina√ß√£o -->
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 15px;">8. Inclina√ß√£o (graus)</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>M√©dia Inclina√ß√£o dos Palos:</label>
                                        <input type="number" id="mediaInclinacao" step="0.1" placeholder="Ex: 2.5">
                                        <small style="color: #666;">0¬∞ = Vertical, >0¬∞ = Direita, <0¬∞ = Esquerda</small>
                                    </div>
                                </div>
                            </div>

                            <!-- 9. Dire√ß√£o das Linhas -->
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 15px;">9. Dire√ß√£o das Linhas</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>M√©dia Dire√ß√£o das Linhas:</label>
                                        <input type="number" id="mediaDirecaoLinhas" step="0.1" placeholder="Ex: 0.0">
                                        <small style="color: #666;">>0 = Ascendente, 0 = Horizontal, <0 = Descendente</small>
                                    </div>
                                </div>
                            </div>

                            <!-- 10. Emotividade (Irregularidades) -->
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 15px;">10. Emotividade - Irregularidades (0-8)</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="irrInclinacao" style="margin-right: 8px;">
                                        <span>Inclina√ß√£o Irregular</span>
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="irrPressao" style="margin-right: 8px;">
                                        <span>Press√£o Irregular</span>
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="irrTamanho" style="margin-right: 8px;">
                                        <span>Tamanho Irregular</span>
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="irrDistanciaPalos" style="margin-right: 8px;">
                                        <span>Dist√¢ncia entre Palos Irregular</span>
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="irrGeneralizadas" style="margin-right: 8px;">
                                        <span>Irregularidades Generalizadas</span>
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="irrDistanciaLinhas" style="margin-right: 8px;">
                                        <span>Dist√¢ncia entre Linhas Irregular</span>
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="irrAlinhamento" style="margin-right: 8px;">
                                        <span>Alinhamento Irregular</span>
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="irrGanhos" style="margin-right: 8px;">
                                        <span>Ganchos Excessivos</span>
                                    </label>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Total Emotividade (calculado automaticamente ou informe):</label>
                                        <input type="number" id="totalEmotividade" min="0" max="8" placeholder="Ser√° calculado automaticamente">
                                    </div>
                                </div>
                            </div>

                            <!-- Dados do Examinando -->
                            <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">üìã Dados do Examinando</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Regi√£o:</label>
                                        <select id="palograficoRegiao">
                                            <option value="Sudeste" selected>Sudeste</option>
                                            <option value="Nordeste">Nordeste</option>
                                            <option value="Sul">Sul</option>
                                            <option value="Norte">Norte</option>
                                            <option value="Centro-Oeste">Centro-Oeste</option>
                                            <option value="Total">Total</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Sexo:</label>
                                        <select id="palograficoSexo">
                                            <option value="M">Masculino</option>
                                            <option value="F">Feminino</option>
                                            <option value="Ambos">Ambos</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Escolaridade:</label>
                                        <select id="palograficoEscolaridade">
                                            <option value="Fundamental">Fundamental</option>
                                            <option value="M√©dio">M√©dio</option>
                                            <option value="Superior" selected>Superior</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Idade:</label>
                                        <input type="number" id="palograficoIdade" min="18" max="64" placeholder="Ex: 35">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Se√ß√£o: An√°lise por IA -->
                        <div id="palograficoIA" style="display: none;">
                            <h3 style="color: #667eea; margin-bottom: 20px;">ü§ñ An√°lise por Intelig√™ncia Artificial</h3>
                            <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <p style="color: #1565c0; margin-bottom: 15px;">
                                    <strong>‚ú® An√°lise Autom√°tica Ativa</strong><br>
                                    Fa√ßa upload da imagem do teste Palogr√°fico e a IA analisar√° automaticamente:
                                </p>
                                <ul style="color: #1565c0; margin-left: 20px;">
                                    <li>‚úÖ Extra√ß√£o autom√°tica de palos por minuto (5 valores)</li>
                                    <li>‚úÖ C√°lculo autom√°tico de produtividade total</li>
                                    <li>‚úÖ Extra√ß√£o de NOR (N√≠vel de Oscila√ß√£o R√≠tmica)</li>
                                    <li>‚úÖ Detec√ß√£o de tamanhos e dist√¢ncias (quando vis√≠veis)</li>
                                    <li>‚úÖ Preenchimento autom√°tico do formul√°rio</li>
                                </ul>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Upload da Imagem do Teste:</label>
                                    <input type="file" id="palograficoImagem" accept="image/*" style="padding: 10px; border: 2px dashed #667eea; border-radius: 8px; width: 100%;">
                                    <small style="color: #666;">Formatos aceitos: JPG, PNG, PDF (at√© 10MB)</small>
                                </div>
                            </div>
                            <div class="analysisPreviewLayout" id="analysisPreviewLayout">
                                <div class="analysisPreviewColumn">
                                    <h4>üìé Imagem carregada</h4>
                                    <img id="analysisOriginalPreview" class="analysisPreviewImage" alt="Preview da imagem carregada">
                                </div>
                                <div class="analysisPreviewColumn">
                                    <h4>üñçÔ∏è Visualiza√ß√£o com marca√ß√µes</h4>
                                    <canvas id="analysisOverlayCanvas"></canvas>
                                    <div class="annotationLegend" id="annotationLegend">
                                        <p>Nenhuma imagem carregada at√© o momento.</p>
                                    </div>
                                </div>
                            </div>
                            <div id="statusAnaliseIA" class="status-analise" style="background: #f5f5f5; border-radius: 8px; padding: 15px; margin-top: 15px; text-align: center; color: #666; display: none;">
                                Aguardando upload de imagem...
                            </div>
                            <!-- √Årea de debug (opcional) -->
                            <div class="mt-3" style="display: none; margin-top: 15px;" id="debug-container">
                                <label for="debug-texto-extraido" style="font-weight: bold; color: #666;">Texto Extra√≠do (Debug)</label>
                                <textarea id="debug-texto-extraido" class="form-control" rows="4" readonly 
                                          placeholder="Texto extra√≠do da imagem aparecer√° aqui..." style="font-size: 11px; font-family: monospace; margin-top: 5px;"></textarea>
                            </div>
                            <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 20px; margin-top: 20px;">
                                <h4 style="color: #2e7d32; margin-bottom: 15px;">üìã Dados do Examinando (para sele√ß√£o da tabela normativa)</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Regi√£o:</label>
                                        <select id="palograficoRegiaoIA">
                                            <option value="Sudeste" selected>Sudeste</option>
                                            <option value="Nordeste">Nordeste</option>
                                            <option value="Sul">Sul</option>
                                            <option value="Norte">Norte</option>
                                            <option value="Centro-Oeste">Centro-Oeste</option>
                                            <option value="Total">Total</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Sexo:</label>
                                        <select id="palograficoSexoIA">
                                            <option value="M">Masculino</option>
                                            <option value="F">Feminino</option>
                                            <option value="Ambos">Ambos</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Escolaridade:</label>
                                        <select id="palograficoEscolaridadeIA">
                                            <option value="Fundamental">Fundamental</option>
                                            <option value="M√©dio">M√©dio</option>
                                            <option value="Superior" selected>Superior</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Idade:</label>
                                        <input type="number" id="palograficoIdadeIA" min="18" max="64" placeholder="Ex: 35">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rotas de Aten√ß√£o Form -->
                    <div id="rotasFormManual" style="display: none;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üõ£Ô∏è Rotas de Aten√ß√£o (C, A, D)</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 14px; text-align: center;">Ordem de aplica√ß√£o: Concentrada ‚Üí Alternada ‚Üí Dividida</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                            <!-- Rota C - Aten√ß√£o Concentrada (PRIMEIRA) -->
                            <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">C</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #388e3c; margin: 0;">Rota C - Aten√ß√£o Concentrada</h4>
                                    <p style="font-size: 12px; color: #666; margin-top: 5px;">1¬™ Aplica√ß√£o</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosRotaC" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosRotaC" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesRotaC" min="0" max="50" value="0">
                                </div>
                            </div>

                            <!-- Rota A - Aten√ß√£o Alternada (SEGUNDA) -->
                            <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #2196f3; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">A</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #1976d2; margin: 0;">Rota A - Aten√ß√£o Alternada</h4>
                                    <p style="font-size: 12px; color: #666; margin-top: 5px;">2¬™ Aplica√ß√£o</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosRotaA" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosRotaA" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesRotaA" min="0" max="50" value="0">
                                </div>
                            </div>

                            <!-- Rota D - Aten√ß√£o Dividida (TERCEIRA) -->
                            <div style="background: #f3e5f5; border: 2px solid #9c27b0; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #9c27b0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">D</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #7b1fa2; margin: 0;">Rota D - Aten√ß√£o Dividida</h4>
                                    <p style="font-size: 12px; color: #666; margin-top: 5px;">3¬™ Aplica√ß√£o</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosRotaD" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosRotaD" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesRotaD" min="0" max="50" value="0">
                                </div>
                            </div>
                        </div>


                        <!-- Seletor de Tabela Normativa -->
                        <div style="background: #f5f5f5; border: 2px solid #ddd; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label style="font-weight: bold; color: #333; margin-bottom: 10px; display: block;">
                                    üìã Tabela Normativa (Opcional):
                                </label>
                                <select id="rotasTabelaId" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                                    <option value="">Selecione uma tabela (opcional - ser√° buscada automaticamente se n√£o selecionada)</option>
                                </select>
                                <p style="color: #666; font-size: 12px; margin-top: 8px; margin-bottom: 0;">
                                    Se n√£o selecionar, o sistema tentar√° buscar uma tabela padr√£o automaticamente.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- BPA-2 Form -->
                    <div id="bpa2FormManual" style="display: none;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üëÅÔ∏è BPA-2 - Bateria de Provas de Aten√ß√£o</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 14px; text-align: center;">Teste de aten√ß√£o com tr√™s modalidades: Alternada (AA), Concentrada (AC) e Dividida (AD)</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                            <!-- Aten√ß√£o Alternada (AA) -->
                            <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #2196f3; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">AA</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #1976d2; margin: 0;">Aten√ß√£o Alternada</h4>
                                    <p style="font-size: 11px; color: #666; margin-top: 5px;">2 min 30 seg</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosAlternada" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosAlternada" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesAlternada" min="0" value="0">
                                </div>
                            </div>

                            <!-- Aten√ß√£o Concentrada (AC) -->
                            <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">AC</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #388e3c; margin: 0;">Aten√ß√£o Concentrada</h4>
                                    <p style="font-size: 11px; color: #666; margin-top: 5px;">2 minutos</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosConcentrada" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosConcentrada" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesConcentrada" min="0" value="0">
                                </div>
                            </div>

                            <!-- Aten√ß√£o Dividida (AD) -->
                            <div style="background: #f3e5f5; border: 2px solid #9c27b0; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #9c27b0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">AD</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #7b1fa2; margin: 0;">Aten√ß√£o Dividida</h4>
                                    <p style="font-size: 11px; color: #666; margin-top: 5px;">4 minutos</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosDividida" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosDividida" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesDividida" min="0" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Seletor de Tabela Normativa e Crit√©rios -->
                        <div style="background: #f5f5f5; border: 2px solid #ddd; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="font-weight: bold; color: #333; margin-bottom: 10px; display: block;">
                                    üìã Tabela Normativa (Opcional):
                                </label>
                                <select id="bpa2TabelaId" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                                    <option value="">Selecione uma tabela (opcional - ser√° buscada automaticamente se n√£o selecionada)</option>
                                </select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label style="font-weight: bold; color: #333; margin-bottom: 8px; display: block; font-size: 13px;">
                                        üë§ Idade/Faixa Et√°ria (Opcional):
                                    </label>
                                    <select id="bpa2Idade" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                                        <option value="">Selecione a idade (opcional)</option>
                                        <option value="6 anos">6 anos</option>
                                        <option value="7 anos">7 anos</option>
                                        <option value="8 anos">8 anos</option>
                                        <option value="9 anos">9 anos</option>
                                        <option value="10 anos">10 anos</option>
                                        <option value="11 anos">11 anos</option>
                                        <option value="12 anos">12 anos</option>
                                        <option value="13 anos">13 anos</option>
                                        <option value="14 anos">14 anos</option>
                                        <option value="15-17 anos">15-17 anos</option>
                                        <option value="18-20 anos">18-20 anos</option>
                                        <option value="21-30 anos">21-30 anos</option>
                                        <option value="31-40 anos">31-40 anos</option>
                                        <option value="41-50 anos">41-50 anos</option>
                                        <option value="51-60 anos">51-60 anos</option>
                                        <option value="61-70 anos">61-70 anos</option>
                                        <option value="71-80 anos">71-80 anos</option>
                                        <option value="81 anos ou mais">81 anos ou mais</option>
                                        <option value="Amostra Total">Amostra Total (padr√£o)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="font-weight: bold; color: #333; margin-bottom: 8px; display: block; font-size: 13px;">
                                        üéì Escolaridade (Opcional):
                                    </label>
                                    <select id="bpa2Escolaridade" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                                        <option value="">Selecione a escolaridade (opcional)</option>
                                        <option value="N√£o alfabetizado">N√£o alfabetizado</option>
                                        <option value="Ensino Fundamental">Ensino Fundamental</option>
                                        <option value="Ensino M√©dio/T√©cnico/Profissionalizante">Ensino M√©dio/T√©cnico/Profissionalizante</option>
                                        <option value="Ensino Superior e/ou P√≥s-Gradua√ß√£o">Ensino Superior e/ou P√≥s-Gradua√ß√£o</option>
                                        <option value="Amostra Total">Amostra Total (padr√£o)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <p style="color: #666; font-size: 12px; margin-top: 12px; margin-bottom: 0;">
                                üí° <strong>Dica:</strong> Selecione idade OU escolaridade para usar normas espec√≠ficas. Se n√£o selecionar, ser√° usado "Amostra Total".
                                <br>‚ö†Ô∏è <strong>Importante:</strong> Se selecionar uma tabela por idade, escolha tamb√©m a idade. Se por escolaridade, escolha a escolaridade.
                            </p>
                        </div>
                    </div>

                    <!-- Mem√≥ria Form -->
                    <div id="memoriaFormManual" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Evoca√ß√£o Imediata:</label>
                                <input type="number" id="evocacaoImediata" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Evoca√ß√£o Tardia:</label>
                                <input type="number" id="evocacaoTardia" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Reten√ß√£o (opcional):</label>
                                <input type="number" id="retencao" min="0" placeholder="Ser√° calculada">
                            </div>
                            <div class="form-group">
                                <label>Reconhecimento (opcional):</label>
                                <input type="number" id="reconhecimento" min="0" placeholder="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Regi√£o:</label>
                                <select id="memoriaRegiao">
                                    <option value="Sudeste" selected>Sudeste</option>
                                    <option value="Sul">Sul</option>
                                    <option value="Nordeste">Nordeste</option>
                                    <option value="Norte">Norte</option>
                                    <option value="Centro-oeste">Centro-Oeste</option>
                                    <option value="Geral">Geral</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Escolaridade:</label>
                                <select id="memoriaEscolaridade">
                                    <option value="Fundamental">Fundamental</option>
                                    <option value="M√©dio">M√©dio</option>
                                    <option value="Superior" selected>Superior</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Idade:</label>
                                <input type="number" id="memoriaIdade" min="18" max="100" placeholder="26">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload de Imagem -->
                <div id="imagemForm" style="display: none;">
                    <div class="imageUploadArea" id="imageUploadArea">
                        <p>üì∑ Clique ou arraste uma imagem do teste aqui</p>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        <img id="imagePreview" class="imagePreview" style="display: none;">
                        <p id="imageStatus" style="margin-top: 10px; color: #666;"></p>
                    </div>
                </div>

                <div class="buttonGroup">
                    <button class="btn btn-secondary" onclick="voltarStep(1)">Voltar</button>
                    <button class="btn" onclick="calcularTeste()">Calcular</button>
                </div>
            </div>

            <!-- Step 3: Sele√ß√£o de Tabela -->
            <div class="formSection" id="section3">
                <h2>Tabela Normativa</h2>
                <div id="tabelaInfo" style="margin: 20px 0;">
                    <p>Tabela selecionada automaticamente com base nos crit√©rios informados.</p>
                </div>
                <div class="buttonGroup">
                    <button class="btn btn-secondary" onclick="voltarStep(2)">Voltar</button>
                    <button class="btn" onclick="avancarStep(4)">Ver Resultado</button>
                </div>
            </div>

            <!-- Step 4: Resultado -->
            <div class="formSection" id="section4">
                <h2>Resultado do Teste</h2>
                <div id="resultadoContainer"></div>
                <div class="buttonGroup">
                    <button class="btn btn-secondary" onclick="voltarStep(3)">Voltar</button>
                    <button class="btn btn-success" onclick="iniciarNovo()">Novo Teste</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3002';
        let currentStep = 1;
        let selectedTest = null;
        let inputMethod = 'manual';
        let resultadoCalculado = null;
        let lastUploadedImageDataUrl = null;
        let analysisBaseImage = null;
        let analysisCanvasContext = null;
        let pendingAnnotationData = { dados: {}, meta: {} };

        const analysisPreviewLayout = document.getElementById('analysisPreviewLayout');
        const analysisOriginalPreview = document.getElementById('analysisOriginalPreview');
        const analysisOverlayCanvas = document.getElementById('analysisOverlayCanvas');
        const annotationLegend = document.getElementById('annotationLegend');

        if (analysisOverlayCanvas) {
            analysisCanvasContext = analysisOverlayCanvas.getContext('2d');
        }

        function escapeHtml(value) {
            if (value === undefined || value === null) return '';
            const str = String(value);
            return str.replace(/[&<>"']/g, (char) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[char]);
        }

        function limparPreviewAnalise(options = {}) {
            if (analysisCanvasContext && analysisOverlayCanvas) {
                analysisCanvasContext.clearRect(0, 0, analysisOverlayCanvas.width || 0, analysisOverlayCanvas.height || 0);
            }
            if (analysisOriginalPreview) {
                analysisOriginalPreview.removeAttribute('src');
            }
            if (analysisPreviewLayout && options.ocultar) {
                analysisPreviewLayout.style.display = 'none';
            }
            updateAnnotationLegend({}, { message: 'Nenhuma imagem carregada.' });
            analysisBaseImage = null;
            lastUploadedImageDataUrl = null;
            pendingAnnotationData = { dados: {}, meta: {} };
        }

        function carregarImagemParaPreview(dataUrl) {
            if (!analysisOverlayCanvas || !analysisCanvasContext) return;
            analysisBaseImage = new Image();
            analysisBaseImage.onload = () => {
                analysisOverlayCanvas.width = analysisBaseImage.width;
                analysisOverlayCanvas.height = analysisBaseImage.height;
                if (analysisPreviewLayout) {
                    analysisPreviewLayout.style.display = 'flex';
                }
                renderAnalysisOverlay(pendingAnnotationData.dados, pendingAnnotationData.meta);
            };
            analysisBaseImage.src = dataUrl;
        }

        function drawGuideRect(ctx, x, y, w, h, strokeColor, fillColor, label) {
            ctx.save();
            ctx.lineWidth = Math.max(2, ctx.canvas.width * 0.003);
            ctx.strokeStyle = strokeColor;
            if (fillColor) {
                ctx.fillStyle = fillColor;
                ctx.fillRect(x, y, w, h);
            }
            ctx.strokeRect(x, y, w, h);
            if (label) {
                ctx.font = `${Math.max(16, ctx.canvas.width * 0.02)}px 'Segoe UI', sans-serif`;
                ctx.fillStyle = strokeColor;
                ctx.shadowColor = 'rgba(255, 255, 255, 0.65)';
                ctx.shadowBlur = Math.max(2, ctx.canvas.width * 0.003);
                ctx.fillText(label, x + Math.max(10, ctx.canvas.width * 0.015), y + Math.max(22, ctx.canvas.height * 0.035));
            }
            ctx.restore();
        }

        function renderAnalysisOverlay(dados = {}, meta = {}) {
            pendingAnnotationData = { dados, meta };
            if (!analysisCanvasContext || !analysisBaseImage || !analysisBaseImage.complete) {
                updateAnnotationLegend(dados, meta);
                return;
            }

            const canvas = analysisOverlayCanvas;
            const ctx = analysisCanvasContext;
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);
            ctx.drawImage(analysisBaseImage, 0, 0, width, height);

            drawGuideRect(ctx, width * 0.05, height * 0.03, width * 0.58, height * 0.14, 'rgba(63,81,181,0.95)', 'rgba(63,81,181,0.12)', 'Dados pessoais');
            drawGuideRect(ctx, width * 0.67, height * 0.03, width * 0.28, height * 0.14, 'rgba(76,175,80,0.95)', 'rgba(76,175,80,0.14)', 'Tempos');
            drawGuideRect(ctx, width * 0.67, height * 0.18, width * 0.28, height * 0.12, 'rgba(255,152,0,0.9)', 'rgba(255,152,0,0.14)', 'Diferen√ßas');
            drawGuideRect(ctx, width * 0.05, height * 0.22, width * 0.9, height * 0.62, 'rgba(94,53,177,0.9)', 'rgba(94,53,177,0.07)', 'Campo de palos');

            ctx.save();
            ctx.font = `${Math.max(18, width * 0.02)}px 'Segoe UI', sans-serif`;
            ctx.shadowColor = 'rgba(255,255,255,0.8)';
            ctx.shadowBlur = Math.max(2, width * 0.002);
            if (dados.temposPalografico && dados.temposPalografico.length === 5) {
                ctx.fillStyle = 'rgba(27,94,32,0.95)';
                ctx.fillText(`Tempos: ${dados.temposPalografico.join(' ‚Ä¢ ')}`, width * 0.68, height * 0.11);
            } else {
                ctx.fillStyle = 'rgba(198,40,40,0.95)';
                ctx.fillText('Tempos n√£o detectados automaticamente', width * 0.64, height * 0.11);
            }
            ctx.restore();

            updateAnnotationLegend(dados, meta);
        }

        function updateAnnotationLegend(dados = {}, meta = {}) {
            if (!annotationLegend) return;

            const linhas = [];
            if (meta.message) {
                linhas.push(escapeHtml(meta.message));
            }

            if (meta.confianca !== undefined) {
                linhas.push(`<strong>Confian√ßa da IA:</strong> ${escapeHtml(meta.confianca)}%`);
            }

            if (dados.temposPalografico && dados.temposPalografico.length === 5) {
                linhas.push(`<strong>Tempos (IA):</strong> ${dados.temposPalografico.map((tempo) => escapeHtml(tempo)).join(' ‚Ä¢ ')}`);
            } else {
                linhas.push('Tempos n√£o foram identificados automaticamente.');
            }

            ['identificador', 'nomeCompleto', 'dataAplicacao', 'idade', 'escolaridade', 'localNascimento'].forEach((campo) => {
                if (dados[campo]) {
                    const rotulo = campo
                        .replace(/([A-Z])/g, ' $1')
                        .replace(/^./, (c) => c.toUpperCase());
                    linhas.push(`<strong>${escapeHtml(rotulo)}:</strong> ${escapeHtml(dados[campo])}`);
                }
            });

            if (linhas.length === 0) {
                linhas.push('Nenhuma informa√ß√£o dispon√≠vel.');
            }

            annotationLegend.innerHTML = `<p>${linhas.join('<br>')}</p>`;
        }

        // Sele√ß√£o de teste
        document.querySelectorAll('.testCard').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.testCard').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedTest = card.dataset.test;
                atualizarTimeline(1);
            });
        });

        // Avan√ßar para pr√≥ximo passo
        function avancarStep(step) {
            if (step === 2 && !selectedTest) {
                alert('Por favor, selecione um teste primeiro');
                return;
            }
            currentStep = step;
            atualizarTimeline(step);
            mostrarSection(step);
        }

        // Voltar para passo anterior
        function voltarStep(step) {
            currentStep = step;
            atualizarTimeline(step);
            mostrarSection(step);
        }

        // Atualizar timeline
        function atualizarTimeline(step) {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
        }

        // Mostrar se√ß√£o
        function mostrarSection(step) {
            document.querySelectorAll('.formSection').forEach(s => s.classList.remove('active'));
            document.getElementById(`section${step}`).classList.add('active');
        }

        // M√©todo de entrada
        function setInputMethod(method) {
            inputMethod = method;
            document.getElementById('manualForm').style.display = method === 'manual' ? 'block' : 'none';
            document.getElementById('imagemForm').style.display = method === 'imagem' ? 'block' : 'none';
            
            if (method === 'manual') {
                mostrarFormManual();
            }
        }

        // Mostrar formul√°rio manual correto
        function mostrarFormManual() {
            document.getElementById('acFormManual').style.display = selectedTest === 'ac' ? 'block' : 'none';
            document.getElementById('palograficoFormManual').style.display = selectedTest === 'palografico' ? 'block' : 'none';
            document.getElementById('rotasFormManual').style.display = selectedTest === 'rotas' ? 'block' : 'none';
            document.getElementById('bpa2FormManual').style.display = selectedTest === 'bpa2' ? 'block' : 'none';
            document.getElementById('memoriaFormManual').style.display = selectedTest === 'memoria' ? 'block' : 'none';
            
            // Carregar tabelas quando o formul√°rio de Rotas ou BPA-2 for exibido
            if (selectedTest === 'rotas') {
                // Aguardar um pouco para garantir que o DOM est√° pronto
                setTimeout(() => carregarTabelasRotas(), 100);
            }
            if (selectedTest === 'bpa2') {
                // Aguardar um pouco para garantir que o DOM est√° pronto
                setTimeout(() => carregarTabelasBPA2(), 100);
            }
            
            // Configurar altern√¢ncia de modo para Palogr√°fico
            if (selectedTest === 'palografico') {
                setTimeout(() => {
                    configurarModoPalografico();
                    calcularValoresAutomaticosPalografico();
                    configurarUploadImagemPalografico();
                }, 100);
            }
            
            // Outros testes (por enquanto sem formul√°rios espec√≠ficos, mas preparados)
            // TODO: Adicionar formul√°rios para BETA-III, MEMORE, MIG, MVT, R-1
        }

        // Configurar altern√¢ncia entre modo manual e IA para Palogr√°fico
        function configurarModoPalografico() {
            const radios = document.querySelectorAll('input[name="palograficoModo"]');
            const manualDiv = document.getElementById('palograficoManual');
            const iaDiv = document.getElementById('palograficoIA');
            
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'manual') {
                        manualDiv.style.display = 'block';
                        iaDiv.style.display = 'none';
                        limparPreviewAnalise({ ocultar: true });
                    } else {
                        manualDiv.style.display = 'none';
                        iaDiv.style.display = 'block';
                    }
                });
            });
        }

        // Calcular valores automaticamente para Palogr√°fico quando poss√≠vel
        function calcularValoresAutomaticosPalografico() {
            // Calcular Produtividade e NOR quando tempos mudarem
            const tempoInputs = ['tempo1', 'tempo2', 'tempo3', 'tempo4', 'tempo5'];
            tempoInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', calcularProdutividadeENOR);
                }
            });

            // Calcular Tamanho M√©dio quando tamanhos mudarem
            const tamanhoInputs = ['tamanhosMaiores', 'tamanhosMenores'];
            tamanhoInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', calcularTamanhoMedio);
                }
            });

            // Calcular Dist√¢ncia M√©dia quando dist√¢ncia total mudar
            const distanciaInput = document.getElementById('distanciaTotal');
            if (distanciaInput) {
                distanciaInput.addEventListener('input', calcularDistanciaMedia);
            }

            // Calcular Emotividade quando checkboxes mudarem
            const irregularidadeCheckboxes = [
                'irrInclinacao', 'irrPressao', 'irrTamanho', 'irrDistanciaPalos',
                'irrGeneralizadas', 'irrDistanciaLinhas', 'irrAlinhamento', 'irrGanhos'
            ];
            irregularidadeCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', calcularEmotividade);
                }
            });
        }

        // Calcular Produtividade e NOR automaticamente
        function calcularProdutividadeENOR() {
            const tempos = [
                parseInt(document.getElementById('tempo1').value) || 0,
                parseInt(document.getElementById('tempo2').value) || 0,
                parseInt(document.getElementById('tempo3').value) || 0,
                parseInt(document.getElementById('tempo4').value) || 0,
                parseInt(document.getElementById('tempo5').value) || 0
            ];
            
            const produtividade = tempos.reduce((a, b) => a + b, 0);
            const produtividadeInput = document.getElementById('produtividade');
            if (produtividadeInput && !produtividadeInput.value) {
                produtividadeInput.value = produtividade;
            }

            // Calcular NOR
            if (produtividade > 0) {
                const diferencas = [];
                for (let i = 1; i < tempos.length; i++) {
                    diferencas.push(Math.abs(tempos[i] - tempos[i-1]));
                }
                const somaDiferencas = diferencas.reduce((a, b) => a + b, 0);
                // F√≥rmula conforme manual: (soma das diferen√ßas √ó 100) / produtividade
                const nor = (somaDiferencas * 100) / produtividade;
                const norInput = document.getElementById('nor');
                if (norInput && !norInput.value) {
                    // Arredondar para 1 casa decimal conforme manual
                    norInput.value = Math.round(nor * 10) / 10;
                }
            }
        }

        // Calcular Tamanho M√©dio automaticamente
        function calcularTamanhoMedio() {
            const maioresStr = document.getElementById('tamanhosMaiores').value;
            const menoresStr = document.getElementById('tamanhosMenores').value;
            
            if (maioresStr && menoresStr) {
                const maiores = maioresStr.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
                const menores = menoresStr.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
                
                if (maiores.length > 0 && menores.length > 0) {
                    const mediaGrandes = maiores.reduce((a, b) => a + b, 0) / maiores.length;
                    const mediaMenores = menores.reduce((a, b) => a + b, 0) / menores.length;
                    const mediaTotal = (mediaGrandes + mediaMenores) / 2;
                    
                    const mediaInput = document.getElementById('mediaTamanhoPalos');
                    if (mediaInput && !mediaInput.value) {
                        mediaInput.value = Math.round(mediaTotal * 10) / 10;
                    }

                    // Calcular Impulsividade
                    const maiorValor = Math.max(...maiores);
                    const menorValor = Math.min(...menores);
                    const impulsividadeInput = document.getElementById('impulsividade');
                    if (impulsividadeInput && !impulsividadeInput.value) {
                        impulsividadeInput.value = Math.round((maiorValor - menorValor) * 10) / 10;
                    }
                }
            }
        }

        // Calcular Dist√¢ncia M√©dia automaticamente
        function calcularDistanciaMedia() {
            const distanciaTotal = parseFloat(document.getElementById('distanciaTotal').value);
            const produtividade = parseInt(document.getElementById('produtividade').value);
            
            if (distanciaTotal && produtividade > 0) {
                const distanciaMedia = distanciaTotal / produtividade;
                const distanciaMediaInput = document.getElementById('distanciaMedia');
                if (distanciaMediaInput && !distanciaMediaInput.value) {
                    distanciaMediaInput.value = Math.round(distanciaMedia * 100) / 100;
                }
            }
        }

        // Calcular Emotividade automaticamente
        function calcularEmotividade() {
            const irregularidades = [
                'irrInclinacao', 'irrPressao', 'irrTamanho', 'irrDistanciaPalos',
                'irrGeneralizadas', 'irrDistanciaLinhas', 'irrAlinhamento', 'irrGanhos'
            ];
            
            let contador = 0;
            irregularidades.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && checkbox.checked) {
                    contador++;
                }
            });
            
            const emotividadeInput = document.getElementById('totalEmotividade');
            if (emotividadeInput && !emotividadeInput.value) {
                emotividadeInput.value = contador;
            }
        }

        // Configurar upload de imagem para an√°lise autom√°tica
        function configurarUploadImagemPalografico() {
            const imagemInput = document.getElementById('palograficoImagem');
            const statusDiv = document.getElementById('statusAnaliseIA');
            
            if (imagemInput) {
                imagemInput.addEventListener('change', async function(e) {
                    const arquivo = e.target.files[0];
                    if (!arquivo) return;
                    
                    // Verificar tamanho
                    const tamanhoMB = (arquivo.size / 1024 / 1024).toFixed(2);
                    if (tamanhoMB > 10) {
                        if (statusDiv) {
                            statusDiv.textContent = `‚ùå Imagem muito grande (${tamanhoMB}MB). M√°ximo: 10MB.`;
                            statusDiv.style.display = 'block';
                            statusDiv.style.background = '#f8d7da';
                            statusDiv.style.color = '#721c24';
                        }
                        return;
                    }
                    
                    limparPreviewAnalise();

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        lastUploadedImageDataUrl = event.target.result;
                        if (analysisOriginalPreview) {
                            analysisOriginalPreview.src = lastUploadedImageDataUrl;
                        }
                        if (analysisPreviewLayout) {
                            analysisPreviewLayout.style.display = 'flex';
                        }
                        pendingAnnotationData = {
                            dados: {},
                            meta: { message: 'Imagem carregada. Clique em "Calcular" para analisar.' }
                        };
                        updateAnnotationLegend({}, pendingAnnotationData.meta);
                        carregarImagemParaPreview(lastUploadedImageDataUrl);
                    };
                    reader.readAsDataURL(arquivo);
                    
                    // Mostrar preview e iniciar an√°lise
                    if (statusDiv) {
                        statusDiv.style.display = 'block';
                        statusDiv.textContent = 'üì∏ Imagem carregada. Clique em "Calcular" para analisar.';
                        statusDiv.style.background = '#d1ecf1';
                        statusDiv.style.color = '#0c5460';
                    }
                });
            }
        }

        // Carregar tabelas normativas para BPA-2
        async function carregarTabelasBPA2() {
            const select = document.getElementById('bpa2TabelaId');
            if (!select) {
                console.error('‚ùå Elemento bpa2TabelaId n√£o encontrado no DOM');
                return;
            }

            console.log('üîç Iniciando carregamento de tabelas BPA-2...');

            try {
                // Adicionar timestamp para evitar cache
                const timestamp = new Date().getTime();
                const url = `${API_BASE}/api/bpa2/tabelas?_t=${timestamp}`;
                console.log('üì° Fazendo requisi√ß√£o para:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                console.log('üì• Resposta recebida. Status:', response.status, response.statusText);
                
                // Verificar se a resposta √© v√°lida (n√£o 404)
                if (!response.ok && response.status === 404) {
                    console.warn('‚ö†Ô∏è Rota /api/bpa2/tabelas n√£o encontrada (404). Continuando sem tabelas.');
                    console.warn('üí° Dica: Tente atualizar a p√°gina com Ctrl+F5 para limpar o cache');
                    select.innerHTML = '<option value="">Tabela normativa opcional - ser√° calculado sem tabela se n√£o selecionada</option>';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üìä Dados recebidos:', JSON.stringify(data, null, 2));

                // Limpar op√ß√µes existentes
                select.innerHTML = '<option value="">Selecione uma tabela (opcional - ser√° buscada automaticamente se n√£o selecionada)</option>';

                if (data.success && data.data && data.data.tabelas && data.data.tabelas.length > 0) {
                    console.log(`‚úÖ Encontradas ${data.data.tabelas.length} tabela(s) para popular o dropdown`);
                    
                    // Agrupar tabelas por crit√©rio
                    const tabelasPorCriterio = {};
                    data.data.tabelas.forEach(tabela => {
                        const criterio = tabela.criterio || 'geral';
                        if (!tabelasPorCriterio[criterio]) {
                            tabelasPorCriterio[criterio] = [];
                        }
                        tabelasPorCriterio[criterio].push(tabela);
                    });
                    
                    // Adicionar op√ß√µes agrupadas por crit√©rio
                    Object.keys(tabelasPorCriterio).sort().forEach(criterio => {
                        const tabelasCriterio = tabelasPorCriterio[criterio];
                        
                        // Adicionar grupo (optgroup) se houver mais de uma tabela por crit√©rio
                        if (tabelasCriterio.length > 1) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = `üìã Crit√©rio: ${criterio.charAt(0).toUpperCase() + criterio.slice(1)} (${tabelasCriterio.length} tabelas)`;
                            optgroup.dataset.criterio = criterio;
                            
                            tabelasCriterio.forEach((tabela, index) => {
                                console.log(`  ${index + 1}. ID: ${tabela.id}, Nome: ${tabela.nome}, Crit√©rio: ${criterio}`);
                                const option = document.createElement('option');
                                option.value = tabela.id;
                                option.dataset.criterio = criterio;
                                const nomeDisplay = tabela.nome || 'Tabela sem nome';
                                const versaoDisplay = tabela.versao ? ` (v${tabela.versao})` : '';
                                option.textContent = `${nomeDisplay}${versaoDisplay}`;
                                optgroup.appendChild(option);
                            });
                            
                            select.appendChild(optgroup);
                        } else {
                            // Tabela √∫nica sem crit√©rio ou crit√©rio √∫nico
                            tabelasCriterio.forEach((tabela, index) => {
                                console.log(`  ${index + 1}. ID: ${tabela.id}, Nome: ${tabela.nome}, Crit√©rio: ${criterio}`);
                                const option = document.createElement('option');
                                option.value = tabela.id;
                                option.dataset.criterio = criterio;
                                const nomeDisplay = tabela.nome || 'Tabela sem nome';
                                const versaoDisplay = tabela.versao ? ` (v${tabela.versao})` : '';
                                const criterioDisplay = criterio !== 'geral' ? ` - ${criterio}` : '';
                                option.textContent = `${nomeDisplay}${versaoDisplay}${criterioDisplay}`;
                                select.appendChild(option);
                            });
                        }
                    });
                    
                    console.log(`‚úÖ ${data.data.tabelas.length} tabela(s) adicionada(s) ao dropdown BPA-2`);
                    console.log(`‚úÖ Dropdown agora tem ${select.options.length} op√ß√£o(√µes)`);
                } else {
                    console.warn('‚ö†Ô∏è Nenhuma tabela encontrada na resposta:', data);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhuma tabela dispon√≠vel - calcule sem tabela (apenas pontos)';
                    option.disabled = true;
                    select.appendChild(option);
                    console.log('‚ö†Ô∏è Nenhuma tabela normativa dispon√≠vel para BPA-2');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar tabelas de BPA-2:', error);
                console.error('   Stack:', error.stack);
                // N√£o bloquear - permitir c√°lculo sem tabela
                select.innerHTML = '<option value="">Tabela normativa opcional - ser√° calculado sem tabela se n√£o selecionada</option>';
                console.log('‚ÑπÔ∏è Continuando sem tabelas. C√°lculo ser√° feito apenas com pontos brutos.');
            }
        }

        // Carregar tabelas normativas para Rotas
        async function carregarTabelasRotas() {
            const select = document.getElementById('rotasTabelaId');
            if (!select) return;

            try {
                // Adicionar timestamp para evitar cache
                const timestamp = new Date().getTime();
                const response = await fetch(`${API_BASE}/api/rotas/tabelas?_t=${timestamp}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const data = await response.json();

                // Limpar op√ß√µes existentes (exceto a primeira)
                select.innerHTML = '<option value="">Selecione uma tabela (opcional - ser√° buscada automaticamente se n√£o selecionada)</option>';

                if (data.success && data.data.tabelas && data.data.tabelas.length > 0) {
                    data.data.tabelas.forEach(tabela => {
                        const option = document.createElement('option');
                        option.value = tabela.id;
                        option.textContent = `${tabela.nome}${tabela.versao ? ' (v' + tabela.versao + ')' : ''}${tabela.criterio ? ' - ' + tabela.criterio : ''}`;
                        select.appendChild(option);
                    });
                    console.log(`‚úÖ ${data.data.tabelas.length} tabela(s) carregada(s) para Rotas`);
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhuma tabela dispon√≠vel - calcule sem tabela (apenas PBs)';
                    option.disabled = true;
                    select.appendChild(option);
                    console.log('‚ö†Ô∏è Nenhuma tabela normativa dispon√≠vel para Rotas');
                }
            } catch (error) {
                console.error('Erro ao carregar tabelas de Rotas:', error);
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Erro ao carregar tabelas - ser√° calculado sem tabela';
                option.disabled = true;
                select.appendChild(option);
            }
        }

        // Upload de imagem
        document.getElementById('imageUploadArea').addEventListener('click', () => {
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Image = e.target.result;
                    document.getElementById('imagePreview').src = base64Image;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imageStatus').textContent = '‚è≥ Analisando imagem com IA...';
                    
                    // Analisar imagem
                    try {
                        // Verificar tamanho da imagem antes de enviar
                        const tamanhoMB = (base64Image.length * 3 / 4 / 1024 / 1024).toFixed(2);
                        if (tamanhoMB > 10) {
                            document.getElementById('imageStatus').textContent = `‚ùå Imagem muito grande (${tamanhoMB}MB). M√°ximo: 10MB. Por favor, redimensione a imagem.`;
                            return;
                        }

                        const response = await fetch(`${API_BASE}/api/imagem/analisar-base64`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                imagem_base64: base64Image,
                                tipo_teste: selectedTest || 'atencao'
                            })
                        });
                        
                        // Verificar se a resposta √© OK antes de tentar parsear JSON
                        if (!response.ok) {
                            let errorMessage = `Erro HTTP ${response.status}: ${response.statusText}`;
                            if (response.status === 413) {
                                errorMessage = 'Imagem muito grande. Por favor, redimensione a imagem para menos de 10MB.';
                            } else {
                                try {
                                    const errorData = await response.json();
                                    errorMessage = errorData.error || errorData.message || errorMessage;
                                } catch (e) {
                                    const text = await response.text();
                                    if (text && !text.startsWith('<!DOCTYPE')) {
                                        errorMessage = text.substring(0, 200);
                                    }
                                }
                            }
                            document.getElementById('imageStatus').textContent = '‚ùå Erro: ' + errorMessage;
                            return;
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            const resultado = data.data;
                            document.getElementById('imageStatus').innerHTML = `
                                ‚úÖ An√°lise conclu√≠da! Confian√ßa: ${resultado.confiancaIA || 'N/A'}%<br>
                                üìä Dados extra√≠dos: ${JSON.stringify(resultado.dadosExtraidos || {}, null, 2)}
                            `;
                            
                            // Preencher formul√°rio automaticamente
                            if (resultado.dadosExtraidos) {
                                preencherFormularioComDados(resultado.dadosExtraidos);
                            }
                        } else {
                            document.getElementById('imageStatus').textContent = '‚ùå Erro: ' + (data.error || data.message || 'Erro desconhecido');
                        }
                    } catch (error) {
                        console.error('Erro ao analisar:', error);
                        document.getElementById('imageStatus').textContent = '‚ùå Erro ao analisar imagem: ' + error.message;
                    }
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Fun√ß√£o melhorada de preenchimento do formul√°rio
        function preencherFormularioComDados(dados, confianca = 0) {
            console.log('üìù Preenchendo formul√°rio com dados extra√≠dos:', dados, 'Confian√ßa:', confianca);
            
            if (selectedTest === 'ac') {
                if (dados.acertos) document.getElementById('acertos').value = dados.acertos;
                if (dados.erros) document.getElementById('erros').value = dados.erros;
                if (dados.omissoes) document.getElementById('omissoes').value = dados.omissoes;
            } else if (selectedTest === 'palografico') {
                let camposPreenchidos = 0;
                
                // Preencher tempos
                if (dados.tempos && Array.isArray(dados.tempos) && dados.tempos.length >= 5) {
                    const camposTempos = ['tempo1', 'tempo2', 'tempo3', 'tempo4', 'tempo5'];
                    
                    camposTempos.forEach((campo, index) => {
                        const elemento = document.getElementById(campo);
                        if (elemento && dados.tempos[index] !== undefined) {
                            elemento.value = dados.tempos[index];
                            elemento.classList.add(confianca >= 70 ? 'campo-preenchido-ia' : 'campo-verificar-ia');
                            camposPreenchidos++;
                        }
                    });
                    
                    console.log('‚úÖ Tempos preenchidos:', dados.tempos);
                }
                
                // Preencher produtividade
                if (dados.produtividade !== null && dados.produtividade !== undefined) {
                    const elemento = document.getElementById('produtividade');
                    if (elemento) {
                        elemento.value = dados.produtividade;
                        elemento.classList.add(confianca >= 70 ? 'campo-preenchido-ia' : 'campo-verificar-ia');
                        camposPreenchidos++;
                        console.log('‚úÖ Produtividade preenchida:', dados.produtividade);
                    }
                }
                
                // Preencher NOR
                if (dados.nor !== null && dados.nor !== undefined) {
                    const elemento = document.getElementById('nor');
                    if (elemento) {
                        elemento.value = dados.nor;
                        elemento.classList.add(confianca >= 70 ? 'campo-preenchido-ia' : 'campo-verificar-ia');
                        camposPreenchidos++;
                        console.log('‚úÖ NOR preenchido:', dados.nor);
                    }
                }
                
                // Preencher tamanho m√©dio
                if (dados.tamanho_medio) {
                    document.getElementById('mediaTamanhoPalos').value = dados.tamanho_medio.toFixed(1);
                    // Aproximar tamanhos maiores e menores se n√£o fornecidos
                    if (!dados.tamanhos_maiores || !dados.tamanhos_menores) {
                        document.getElementById('tamanhosMaiores').value = (dados.tamanho_medio + 1).toFixed(1) + ', ' + (dados.tamanho_medio + 1.5).toFixed(1) + ', ' + (dados.tamanho_medio + 0.5).toFixed(1) + ', ' + (dados.tamanho_medio + 1.2).toFixed(1) + ', ' + (dados.tamanho_medio + 0.8).toFixed(1);
                        document.getElementById('tamanhosMenores').value = (dados.tamanho_medio - 1).toFixed(1) + ', ' + (dados.tamanho_medio - 1.5).toFixed(1) + ', ' + (dados.tamanho_medio - 0.5).toFixed(1) + ', ' + (dados.tamanho_medio - 1.2).toFixed(1) + ', ' + (dados.tamanho_medio - 0.8).toFixed(1);
                    }
                    console.log('‚úÖ Tamanho m√©dio preenchido:', dados.tamanho_medio);
                }
                
                // Preencher dist√¢ncia m√©dia
                if (dados.distancia_media) {
                    document.getElementById('distanciaMedia').value = dados.distancia_media.toFixed(2);
                    // Estimar dist√¢ncia total se n√£o fornecida (assumindo produtividade m√©dia)
                    if (!dados.distancia_total && dados.produtividade) {
                        const distanciaTotal = dados.distancia_media * dados.produtividade;
                        document.getElementById('distanciaTotal').value = distanciaTotal.toFixed(2);
                    }
                    console.log('‚úÖ Dist√¢ncia m√©dia preenchida:', dados.distancia_media);
                }
                
                // Preencher outros campos se dispon√≠veis
                if (dados.impulsividade) {
                    document.getElementById('impulsividade').value = dados.impulsividade.toFixed(1);
                }
                if (dados.media_distancia_linhas) {
                    document.getElementById('mediaDistanciaLinhas').value = dados.media_distancia_linhas.toFixed(2);
                }
                if (dados.media_margem_esquerda) {
                    document.getElementById('mediaMargemEsquerda').value = dados.media_margem_esquerda.toFixed(2);
                }
                if (dados.media_margem_direita) {
                    document.getElementById('mediaMargemDireita').value = dados.media_margem_direita.toFixed(2);
                }
                if (dados.media_margem_superior) {
                    document.getElementById('mediaMargemSuperior').value = dados.media_margem_superior.toFixed(2);
                }
                if (dados.porcentagem_ganchos) {
                    document.getElementById('porcentagemGanchos').value = dados.porcentagem_ganchos.toFixed(1);
                }
                if (dados.media_inclinacao) {
                    document.getElementById('mediaInclinacao').value = dados.media_inclinacao.toFixed(1);
                }
                if (dados.total_emotividade !== null && dados.total_emotividade !== undefined) {
                    document.getElementById('totalEmotividade').value = dados.total_emotividade;
                }
                
                // Preencher irregularidades se dispon√≠veis
                if (dados.irregularidades) {
                    if (dados.irregularidades.inclinacao) document.getElementById('irrInclinacao').checked = true;
                    if (dados.irregularidades.pressao) document.getElementById('irrPressao').checked = true;
                    if (dados.irregularidades.tamanho) document.getElementById('irrTamanho').checked = true;
                    if (dados.irregularidades.distancia_palos) document.getElementById('irrDistanciaPalos').checked = true;
                    if (dados.irregularidades.generalizadas) document.getElementById('irrGeneralizadas').checked = true;
                    if (dados.irregularidades.distancia_linhas) document.getElementById('irrDistanciaLinhas').checked = true;
                    if (dados.irregularidades.alinhamento) document.getElementById('irrAlinhamento').checked = true;
                    if (dados.irregularidades.ganhos) document.getElementById('irrGanhos').checked = true;
                }
                
                // Recalcular valores autom√°ticos ap√≥s preenchimento
                setTimeout(() => {
                    try {
                        calcularProdutividadeENOR();
                        calcularTamanhoMedio();
                        calcularDistanciaMedia();
                        calcularEmotividade();
                        console.log('üîÑ Valores autom√°ticos recalculados');
                    } catch (error) {
                        console.log('‚ö†Ô∏è Erro ao recalcular valores:', error);
                    }
                }, 300);
                
                // Mostrar feedback visual
                if (camposPreenchidos > 0) {
                    mostrarNotificacao(
                        `${camposPreenchidos} campos preenchidos automaticamente (${confianca}% confian√ßa)`,
                        confianca >= 70 ? 'success' : 'warning'
                    );
                }
                
                return camposPreenchidos;
            } else if (selectedTest === 'memoria') {
                if (dados.evocacao_imediata) document.getElementById('evocacaoImediata').value = dados.evocacao_imediata;
                if (dados.evocacao_tardia) document.getElementById('evocacaoTardia').value = dados.evocacao_tardia;
                if (dados.retencao) document.getElementById('retencao').value = dados.retencao;
                if (dados.reconhecimento) document.getElementById('reconhecimento').value = dados.reconhecimento;
            }
            
            return 0;
        }

        // Fun√ß√£o melhorada de processamento da resposta da an√°lise
        async function processarAnaliseIA(analiseData) {
            console.log('üîÑ Processando resposta da an√°lise IA:', analiseData);
            
            const dadosExtraidos = analiseData.analise_ia?.dados_extraidos || {};
            const confianca = analiseData.analise_ia?.confianca || 0;
            const textoExtraido = analiseData.analise_ia?.texto_extraido || '';
            
            // Mostrar debug se dispon√≠vel
            if (analiseData.analise_ia?.debug) {
                console.log('üêõ Debug da an√°lise:', analiseData.analise_ia.debug);
            }
            
            // Sempre tentar preencher formul√°rio se tiver dados
            let camposPreenchidos = 0;
            if (Object.keys(dadosExtraidos).length > 0) {
                camposPreenchidos = preencherFormularioComDados(dadosExtraidos, confianca);
            }
            
            // Mostrar texto extra√≠do em √°rea de debug (se existir)
            const debugArea = document.getElementById('debug-texto-extraido');
            const debugContainer = document.getElementById('debug-container');
            if (debugArea && debugContainer) {
                debugArea.value = textoExtraido;
                debugContainer.style.display = textoExtraido ? 'block' : 'none';
            }
            
            if (lastUploadedImageDataUrl && analysisCanvasContext) {
                const metaInfo = { confianca };
                if (!dadosExtraidos || Object.keys(dadosExtraidos).length === 0) {
                    metaInfo.message = 'A IA n√£o conseguiu identificar valores automaticamente. Utilize os campos ao lado para complementar.';
                }
                renderAnalysisOverlay(dadosExtraidos, metaInfo);
            }
            
            // Se sucesso (c√°lculo autom√°tico), mostrar resultado
            if (analiseData.success && analiseData.data) {
                console.log('‚úÖ Resultado calculado automaticamente');
                
                mostrarNotificacao(
                    `Resultado calculado automaticamente com ${confianca}% de confian√ßa!`,
                    'success'
                );
                
                const statusDiv = document.getElementById('statusAnaliseIA');
                if (statusDiv) {
                    statusDiv.textContent = `‚úÖ An√°lise conclu√≠da! Confian√ßa: ${confianca}% - Resultado calculado automaticamente.`;
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                }
                
                resultadoCalculado = analiseData.data;
                avancarStep(4);
                exibirResultado(analiseData.data);
                return;
            }
            
            // Se preenchimento assistido (dados extra√≠dos mas precisam verifica√ß√£o)
            if (analiseData.preenchimento_assistido) {
                console.log('‚ö†Ô∏è Preenchimento assistido ativado');
                
                mostrarNotificacao(
                    `Dados preenchidos automaticamente (${confianca}% confian√ßa). Verifique e clique em "Calcular".`,
                    'warning',
                    8000 // 8 segundos
                );
                
                const statusDiv = document.getElementById('statusAnaliseIA');
                if (statusDiv) {
                    statusDiv.textContent = `‚ö†Ô∏è An√°lise parcial (${confianca}% confian√ßa). Dados extra√≠dos e formul√°rio preenchido. Revise os valores e clique em "Calcular".`;
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                }
                
                // Destacar bot√£o calcular
                const btnCalcular = document.querySelector('button[onclick*="calcularTeste"]');
                if (btnCalcular) {
                    btnCalcular.style.backgroundColor = '#ffc107';
                    btnCalcular.style.animation = 'pulse 2s infinite';
                    
                    // Remover destaque ap√≥s 5 segundos
                    setTimeout(() => {
                        btnCalcular.style.backgroundColor = '';
                        btnCalcular.style.animation = '';
                    }, 5000);
                }
                
                return;
            }
            
            // Se erro ou dados insuficientes
            console.log('‚ùå Dados insuficientes ou erro na an√°lise');
            
            mostrarNotificacao(
                analiseData.message || 'N√£o foi poss√≠vel extrair dados da imagem. Preencha manualmente.',
                'error',
                6000
            );
            
            const statusDiv = document.getElementById('statusAnaliseIA');
            if (statusDiv) {
                statusDiv.textContent = '‚ùå ' + (analiseData.message || 'N√£o foi poss√≠vel extrair dados da imagem. Tente usar a entrada manual.');
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
            }
            
            // Se extraiu algum texto, mostrar para debug
            if (textoExtraido && textoExtraido.trim().length > 0) {
                console.log('üìù Texto extra√≠do dispon√≠vel para debug');
            }
        }

        // Fun√ß√£o melhorada de valida√ß√£o antes do c√°lculo
        function validarDadosAntesCalculo() {
            if (selectedTest === 'palografico') {
                // Obter valores dos campos
                const tempos = [
                    parseInt(document.getElementById('tempo1').value) || 0,
                    parseInt(document.getElementById('tempo2').value) || 0,
                    parseInt(document.getElementById('tempo3').value) || 0,
                    parseInt(document.getElementById('tempo4').value) || 0,
                    parseInt(document.getElementById('tempo5').value) || 0
                ];
                
                const produtividadeFornecida = parseInt(document.getElementById('produtividade').value) || 0;
                const norFornecida = parseFloat(document.getElementById('nor').value) || 0;
                
                const somaTempos = tempos.reduce((a, b) => a + b, 0);
                
                // Verificar se temos dados m√≠nimos
                const temTempos = somaTempos > 0;
                const temProdutividade = produtividadeFornecida > 0;
                const temNOR = norFornecida > 0;
                
                console.log('üîç Valida√ß√£o dos dados:', {
                    tempos,
                    somaTempos,
                    produtividadeFornecida,
                    norFornecida,
                    temTempos,
                    temProdutividade,
                    temNOR
                });
                
                // Precisamos de pelo menos tempos OU (produtividade E NOR)
                if (!temTempos && !(temProdutividade && temNOR)) {
                    mostrarNotificacao(
                        '‚ö†Ô∏è Por favor, preencha os 5 tempos OU informe a produtividade e NOR.',
                        'error'
                    );
                    return false;
                }
                
                // Validar faixas dos valores
                if (temTempos) {
                    const temposInvalidos = tempos.filter((t, i) => t > 0 && (t < 30 || t > 300));
                    if (temposInvalidos.length > 0) {
                        mostrarNotificacao(
                            '‚ö†Ô∏è Alguns tempos est√£o fora da faixa v√°lida (30-300). Verifique os valores.',
                            'warning'
                        );
                    }
                }
                
                if (temProdutividade && (produtividadeFornecida < 100 || produtividadeFornecida > 1000)) {
                    mostrarNotificacao(
                        '‚ö†Ô∏è Produtividade fora da faixa esperada (100-1000). Verifique o valor.',
                        'warning'
                    );
                }
                
                if (temNOR && (norFornecida < 0.1 || norFornecida > 100)) {
                    mostrarNotificacao(
                        '‚ö†Ô∏è NOR fora da faixa esperada (0.1-100). Verifique o valor.',
                        'warning'
                    );
                }
                
                return true;
            }
            
            return true;
        }

        // Fun√ß√£o para mostrar notifica√ß√µes
        function mostrarNotificacao(mensagem, tipo = 'info', duracao = 5000) {
            // Remover notifica√ß√µes existentes
            const existentes = document.querySelectorAll('.notificacao-ia');
            existentes.forEach(n => n.remove());
            
            // Criar nova notifica√ß√£o
            const notificacao = document.createElement('div');
            const tipoClass = tipo === 'error' ? 'danger' : tipo === 'warning' ? 'warning' : tipo === 'success' ? 'success' : 'info';
            notificacao.className = `alert alert-${tipoClass} notificacao-ia`;
            notificacao.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-radius: 8px;
                padding: 15px 20px;
            `;
            notificacao.innerHTML = `
                <button type="button" class="btn-close" onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 20px; cursor: pointer; margin-left: 10px;">&times;</button>
                ${mensagem}
            `;
            
            document.body.appendChild(notificacao);
            
            // Remover automaticamente
            setTimeout(() => {
                if (notificacao.parentNode) {
                    notificacao.remove();
                }
            }, duracao);
        }

        // Calcular teste
        async function calcularTeste() {
            if (!selectedTest) {
                alert('Por favor, selecione um teste');
                return;
            }

            try {
                let response;
                
                if (selectedTest === 'ac') {
                    const acertos = parseInt(document.getElementById('acertos').value);
                    const erros = parseInt(document.getElementById('erros').value);
                    const omissoes = parseInt(document.getElementById('omissoes').value);
                    const regiao = document.getElementById('acRegiao').value;
                    const escolaridade = document.getElementById('acEscolaridade').value;
                    const idade = document.getElementById('acIdade').value ? parseInt(document.getElementById('acIdade').value) : null;

                    response = await fetch(`${API_BASE}/api/ac/calcular`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ acertos, erros, omissoes, regiao, escolaridade, idade })
                    });
                } else if (selectedTest === 'palografico') {
                    // Verificar modo de an√°lise
                    const modo = document.querySelector('input[name="palograficoModo"]:checked')?.value || 'manual';
                    
                    if (modo === 'ia') {
                        // Modo: An√°lise por IA
                        const imagemInput = document.getElementById('palograficoImagem');
                        const arquivo = imagemInput?.files[0];
                        
                        if (!arquivo) {
                            alert('Por favor, selecione uma imagem do teste Palogr√°fico');
                            return;
                        }
                        
                        // Criar FormData para envio de arquivo
                        const formData = new FormData();
                        formData.append('imagem', arquivo);
                        formData.append('regiao', document.getElementById('palograficoRegiaoIA').value);
                        formData.append('sexo', document.getElementById('palograficoSexoIA').value);
                        formData.append('escolaridade', document.getElementById('palograficoEscolaridadeIA').value);
                        formData.append('idade', document.getElementById('palograficoIdadeIA').value || '');
                        formData.append('contexto', 'transito');
                        
                        // Mostrar indicador de carregamento
                        const statusDiv = document.getElementById('statusAnaliseIA');
                        if (statusDiv) {
                            statusDiv.style.display = 'block';
                            statusDiv.textContent = '‚è≥ Analisando imagem com IA... Isso pode levar alguns segundos.';
                            statusDiv.style.background = '#fff3cd';
                            statusDiv.style.color = '#856404';
                        }
                        
                        response = await fetch(`${API_BASE}/api/palografico/analisar-ia`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        // Verificar resposta antes de continuar
                        if (!response.ok) {
                            let errorMessage = `Erro HTTP ${response.status}: ${response.statusText}`;
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.error || errorData.message || errorMessage;
                            } catch (e) {
                                const text = await response.text();
                                if (text && !text.startsWith('<!DOCTYPE')) {
                                    errorMessage = text.substring(0, 200);
                                }
                            }
                            if (statusDiv) {
                                statusDiv.textContent = '‚ùå Erro: ' + errorMessage;
                            }
                            throw new Error(errorMessage);
                        }
                        
                        const analiseData = await response.json();
                        
                        console.log('üìä Resposta completa da an√°lise:', analiseData);
                        console.log('üìä Dados extra√≠dos:', analiseData.analise_ia?.dados_extraidos);
                        
                        // SEMPRE tentar preencher formul√°rio se houver dados extra√≠dos
                        const dadosExtraidos = analiseData.analise_ia?.dados_extraidos || {};
                        const temDados = Object.keys(dadosExtraidos).length > 0;
                        
                        // Processar resposta da an√°lise usando fun√ß√£o melhorada
                        await processarAnaliseIA(analiseData);
                        
                        // Se sucesso (c√°lculo autom√°tico), j√° foi tratado na fun√ß√£o processarAnaliseIA
                        if (analiseData.success && analiseData.data) {
                            return; // N√£o continuar com o fluxo normal
                        }
                        
                        // Se preenchimento assistido, aguardar usu√°rio clicar em "Calcular"
                        if (analiseData.preenchimento_assistido) {
                            return; // N√£o continuar com o fluxo normal
                        }
                        
                        // Se erro ou dados insuficientes, j√° foi tratado na fun√ß√£o processarAnaliseIA
                        return; // N√£o continuar com o fluxo normal
                    } else {
                        // Modo: Entrada Manual (Roteiro Completo)
                        // Validar dados antes de calcular
                        if (!validarDadosAntesCalculo()) {
                            return;
                        }
                        
                        const tempo1 = parseInt(document.getElementById('tempo1').value) || 0;
                        const tempo2 = parseInt(document.getElementById('tempo2').value) || 0;
                        const tempo3 = parseInt(document.getElementById('tempo3').value) || 0;
                        const tempo4 = parseInt(document.getElementById('tempo4').value) || 0;
                        const tempo5 = parseInt(document.getElementById('tempo5').value) || 0;
                        
                        const tempos = [tempo1, tempo2, tempo3, tempo4, tempo5];
                        
                        // Validar que pelo menos alguns dados foram fornecidos
                        const somaTempos = tempos.reduce((a, b) => a + b, 0);
                        const produtividadeInput = document.getElementById('produtividade');
                        const produtividadeFornecida = produtividadeInput && produtividadeInput.value ? parseInt(produtividadeInput.value) : null;
                        
                        // Verificar tamb√©m se o NOR foi preenchido (pode indicar que dados foram extra√≠dos pela IA)
                        const norInput = document.getElementById('nor');
                        const norFornecida = norInput && norInput.value ? parseFloat(norInput.value) : null;
                        
                        // Valida√ß√£o mais flex√≠vel: aceitar se tem tempos, produtividade OU NOR (indicando que dados foram extra√≠dos)
                        if (somaTempos === 0 && !produtividadeFornecida && !norFornecida) {
                            mostrarNotificacao('‚ö†Ô∏è Por favor, preencha pelo menos os palos por minuto (5 minutos) ou informe a produtividade total.', 'error');
                            return;
                        }
                        
                        // Se tem NOR mas n√£o tem tempos nem produtividade, tentar calcular produtividade a partir do NOR
                        // (isso pode acontecer se a IA extraiu apenas o NOR)
                        if (norFornecida && somaTempos === 0 && !produtividadeFornecida) {
                            console.warn('‚ö†Ô∏è Apenas NOR encontrado, mas sem tempos ou produtividade. Tentando prosseguir mesmo assim.');
                        }
                        
                        console.log('üìä Dados coletados do formul√°rio:', {
                            tempos,
                            somaTempos,
                            produtividadeFornecida
                        });
                        
                        const tamanhosMaioresStr = document.getElementById('tamanhosMaiores').value;
                        const tamanhosMenoresStr = document.getElementById('tamanhosMenores').value;
                        const tamanhosMaiores = tamanhosMaioresStr ? tamanhosMaioresStr.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : null;
                        const tamanhosMenores = tamanhosMenoresStr ? tamanhosMenoresStr.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : null;
                        
                        // Coletar irregularidades
                        const irregularidades = {
                            inclinacao: document.getElementById('irrInclinacao').checked,
                            pressao: document.getElementById('irrPressao').checked,
                            tamanho: document.getElementById('irrTamanho').checked,
                            distancia_palos: document.getElementById('irrDistanciaPalos').checked,
                            generalizadas: document.getElementById('irrGeneralizadas').checked,
                            distancia_linhas: document.getElementById('irrDistanciaLinhas').checked,
                            alinhamento: document.getElementById('irrAlinhamento').checked,
                            ganhos: document.getElementById('irrGanhos').checked
                        };
                        
                        // Recalcular produtividade e NOR se necess√°rio (caso tenham sido preenchidos pela IA mas n√£o calculados)
                        let produtividadeFinal = document.getElementById('produtividade').value ? parseInt(document.getElementById('produtividade').value) : null;
                        let norFinal = document.getElementById('nor').value ? parseFloat(document.getElementById('nor').value) : null;
                        
                        // Se n√£o tem produtividade mas tem tempos, calcular
                        if (!produtividadeFinal && somaTempos > 0) {
                            produtividadeFinal = somaTempos;
                            if (document.getElementById('produtividade')) {
                                document.getElementById('produtividade').value = produtividadeFinal;
                            }
                            console.log('‚úÖ Produtividade calculada dos tempos:', produtividadeFinal);
                        }
                        
                        // Se n√£o tem NOR mas tem tempos, calcular
                        if (!norFinal && somaTempos > 0 && produtividadeFinal) {
                            const diferencas = [];
                            for (let i = 1; i < tempos.length; i++) {
                                diferencas.push(Math.abs(tempos[i] - tempos[i-1]));
                            }
                            const somaDiferencas = diferencas.reduce((a, b) => a + b, 0);
                            if (produtividadeFinal > 0) {
                                norFinal = (somaDiferencas * 100) / produtividadeFinal;
                                norFinal = Math.round(norFinal * 10) / 10;
                                if (document.getElementById('nor')) {
                                    document.getElementById('nor').value = norFinal;
                                }
                                console.log('‚úÖ NOR calculado dos tempos:', norFinal);
                            }
                        }
                        
                        // ROTEIRO COMPLETO - Todos os 13 campos
                        const body = {
                            tempos: somaTempos > 0 ? tempos : null,
                            tamanhos_maiores: tamanhosMaiores,
                            tamanhos_menores: tamanhosMenores,
                            distancia_total: document.getElementById('distanciaTotal').value ? parseFloat(document.getElementById('distanciaTotal').value) : null,
                            produtividade: produtividadeFinal,
                            nor: norFinal,
                            media_tamanho_palos: document.getElementById('mediaTamanhoPalos').value ? parseFloat(document.getElementById('mediaTamanhoPalos').value) : null,
                            distancia_media: document.getElementById('distanciaMedia').value ? parseFloat(document.getElementById('distanciaMedia').value) : null,
                            impulsividade: document.getElementById('impulsividade').value ? parseFloat(document.getElementById('impulsividade').value) : null,
                            media_distancia_linhas: document.getElementById('mediaDistanciaLinhas').value ? parseFloat(document.getElementById('mediaDistanciaLinhas').value) : null,
                            media_margem_esquerda: document.getElementById('mediaMargemEsquerda').value ? parseFloat(document.getElementById('mediaMargemEsquerda').value) : null,
                            media_margem_direita: document.getElementById('mediaMargemDireita').value ? parseFloat(document.getElementById('mediaMargemDireita').value) : null,
                            media_margem_superior: document.getElementById('mediaMargemSuperior').value ? parseFloat(document.getElementById('mediaMargemSuperior').value) : null,
                            porcentagem_ganchos: document.getElementById('porcentagemGanchos').value ? parseFloat(document.getElementById('porcentagemGanchos').value) : null,
                            media_inclinacao: document.getElementById('mediaInclinacao').value ? parseFloat(document.getElementById('mediaInclinacao').value) : null,
                            media_direcao_linhas: document.getElementById('mediaDirecaoLinhas').value ? parseFloat(document.getElementById('mediaDirecaoLinhas').value) : null,
                            total_emotividade: document.getElementById('totalEmotividade').value ? parseInt(document.getElementById('totalEmotividade').value) : null,
                            irregularidades: irregularidades,
                            regiao: document.getElementById('palograficoRegiao').value,
                            sexo: document.getElementById('palograficoSexo').value,
                            escolaridade: document.getElementById('palograficoEscolaridade').value,
                            idade: document.getElementById('palograficoIdade').value ? parseInt(document.getElementById('palograficoIdade').value) : null,
                            contexto: 'transito'
                        };

                        response = await fetch(`${API_BASE}/api/palografico/calcular`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                    }
                } else if (selectedTest === 'rotas') {
                    const acertosRotaA = parseInt(document.getElementById('acertosRotaA').value) || 0;
                    const errosRotaA = parseInt(document.getElementById('errosRotaA').value) || 0;
                    const omissoesRotaA = parseInt(document.getElementById('omissoesRotaA').value) || 0;
                    const acertosRotaD = parseInt(document.getElementById('acertosRotaD').value) || 0;
                    const errosRotaD = parseInt(document.getElementById('errosRotaD').value) || 0;
                    const omissoesRotaD = parseInt(document.getElementById('omissoesRotaD').value) || 0;
                    const acertosRotaC = parseInt(document.getElementById('acertosRotaC').value) || 0;
                    const errosRotaC = parseInt(document.getElementById('errosRotaC').value) || 0;
                    const omissoesRotaC = parseInt(document.getElementById('omissoesRotaC').value) || 0;
                    const tabelaId = document.getElementById('rotasTabelaId').value ? parseInt(document.getElementById('rotasTabelaId').value) : null;

                    const body = {
                        acertos_rota_a: acertosRotaA,
                        erros_rota_a: errosRotaA,
                        omissoes_rota_a: omissoesRotaA,
                        acertos_rota_d: acertosRotaD,
                        erros_rota_d: errosRotaD,
                        omissoes_rota_d: omissoesRotaD,
                        acertos_rota_c: acertosRotaC,
                        erros_rota_c: errosRotaC,
                        omissoes_rota_c: omissoesRotaC
                    };

                    // Adicionar tabela_id apenas se foi selecionada
                    if (tabelaId) {
                        body.tabela_id = tabelaId;
                    }

                    response = await fetch(`${API_BASE}/api/rotas/calcular`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                } else if (selectedTest === 'bpa2') {
                    const acertosAlternada = parseInt(document.getElementById('acertosAlternada').value) || 0;
                    const errosAlternada = parseInt(document.getElementById('errosAlternada').value) || 0;
                    const omissoesAlternada = parseInt(document.getElementById('omissoesAlternada').value) || 0;
                    const acertosConcentrada = parseInt(document.getElementById('acertosConcentrada').value) || 0;
                    const errosConcentrada = parseInt(document.getElementById('errosConcentrada').value) || 0;
                    const omissoesConcentrada = parseInt(document.getElementById('omissoesConcentrada').value) || 0;
                    const acertosDividida = parseInt(document.getElementById('acertosDividida').value) || 0;
                    const errosDividida = parseInt(document.getElementById('errosDividida').value) || 0;
                    const omissoesDividida = parseInt(document.getElementById('omissoesDividida').value) || 0;
                    const tabelaSelect = document.getElementById('bpa2TabelaId');
                    const tabelaId = tabelaSelect.value ? parseInt(tabelaSelect.value) : null;
                    const selectedOption = tabelaSelect.options[tabelaSelect.selectedIndex];
                    const criterio = selectedOption && selectedOption.dataset ? selectedOption.dataset.criterio : null;
                    
                    // Obter idade e escolaridade selecionadas
                    const idadeSelect = document.getElementById('bpa2Idade');
                    const escolaridadeSelect = document.getElementById('bpa2Escolaridade');
                    const idade = idadeSelect ? idadeSelect.value : null;
                    const escolaridade = escolaridadeSelect ? escolaridadeSelect.value : null;
                    
                    // Determinar valor_criterio: priorizar idade, depois escolaridade, sen√£o "Amostra Total"
                    let valorCriterio = null;
                    if (idade && idade !== 'Amostra Total') {
                        valorCriterio = idade;
                    } else if (escolaridade && escolaridade !== 'Amostra Total') {
                        valorCriterio = escolaridade;
                    } else {
                        valorCriterio = 'Amostra Total';
                    }

                    const body = {
                        acertos_alternada: acertosAlternada,
                        erros_alternada: errosAlternada,
                        omissoes_alternada: omissoesAlternada,
                        acertos_concentrada: acertosConcentrada,
                        erros_concentrada: errosConcentrada,
                        omissoes_concentrada: omissoesConcentrada,
                        acertos_dividida: acertosDividida,
                        erros_dividida: errosDividida,
                        omissoes_dividida: omissoesDividida,
                        tabela_id: tabelaId,
                        criterio: criterio,
                        idade: idade,
                        escolaridade: escolaridade,
                        valor_criterio: valorCriterio
                    };

                    // Adicionar tabela_id apenas se foi selecionada
                    if (tabelaId) {
                        body.tabela_id = tabelaId;
                    }

                    response = await fetch(`${API_BASE}/api/bpa2/calcular`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                } else if (selectedTest === 'memoria') {
                    const evocacaoImediata = parseInt(document.getElementById('evocacaoImediata').value);
                    const evocacaoTardia = parseInt(document.getElementById('evocacaoTardia').value);
                    const retencao = document.getElementById('retencao').value ? parseInt(document.getElementById('retencao').value) : null;
                    const reconhecimento = document.getElementById('reconhecimento').value ? parseInt(document.getElementById('reconhecimento').value) : null;

                    response = await fetch(`${API_BASE}/api/memoria/calcular`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            evocacao_imediata: evocacaoImediata,
                            evocacao_tardia: evocacaoTardia,
                            retencao: retencao,
                            reconhecimento: reconhecimento,
                            regiao: document.getElementById('memoriaRegiao').value,
                            escolaridade: document.getElementById('memoriaEscolaridade').value,
                            idade: document.getElementById('memoriaIdade').value ? parseInt(document.getElementById('memoriaIdade').value) : null
                        })
                    });
                }

                // Verificar se a resposta √© OK antes de tentar parsear JSON
                if (!response.ok) {
                    let errorMessage = `Erro HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (e) {
                        // Se n√£o conseguir parsear JSON, usar o texto da resposta
                        const text = await response.text();
                        if (text) {
                            errorMessage = text.substring(0, 200); // Limitar tamanho
                        }
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                if (data.success) {
                    resultadoCalculado = data.data;
                    avancarStep(4);
                    exibirResultado(data.data);
                    
                    // Mostrar aviso se houver (ex: tabela n√£o encontrada)
                    if (data.aviso) {
                        alert('‚ÑπÔ∏è ' + data.aviso);
                    }
                } else {
                    // Tratar caso especial: an√°lise por IA em desenvolvimento
                    if (data.aviso && data.message && data.message.includes('desenvolvimento')) {
                        alert('‚ÑπÔ∏è ' + data.aviso + '\n\nPor favor, use a entrada manual por enquanto.');
                        return;
                    }
                    // Melhorar mensagem de erro
                    let mensagemErro = data.error || data.message || 'Erro desconhecido';
                    
                    // N√£o mostrar dica sobre tabela se o erro n√£o for de tabela obrigat√≥ria
                    if (mensagemErro.includes('tabela_id √© obrigat√≥rio') || mensagemErro.includes('tabela_id √© obrigat√≥ria')) {
                        mensagemErro += '\n\nüí° Dica: Popule as tabelas normativas primeiro usando o bot√£o "üóÑÔ∏è Todas" na p√°gina principal.';
                    } else if (mensagemErro.includes('tabela') || mensagemErro.includes('Tabela')) {
                        // Para outros erros de tabela, apenas informar que pode calcular sem
                        mensagemErro += '\n\n‚ÑπÔ∏è Nota: Voc√™ pode calcular sem tabela normativa (apenas pontos brutos).';
                    }
                    
                    alert('‚ùå Erro: ' + mensagemErro);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao calcular: ' + error.message);
            }
        }

        // Exibir resultado
        function exibirResultado(data) {
            const container = document.getElementById('resultadoContainer');
            container.innerHTML = '';

            if (selectedTest === 'ac') {
                container.innerHTML = `
                    <div class="resultBox highlight">
                        <div class="resultValue">${data.pb} pontos</div>
                        <div class="resultLabel">Pontos Brutos (PB)</div>
                    </div>
                    <div class="resultBox">
                        <strong>F√≥rmula:</strong> ${data.formula || 'P = A - (E + O)'}
                    </div>
                    ${data.percentil !== null ? `
                        <div class="resultBox">
                            <strong>Percentil:</strong> ${data.percentil}
                        </div>
                        <div class="resultBox">
                            <strong>Classifica√ß√£o:</strong> ${data.classificacao}
                        </div>
                    ` : ''}
                    <div class="resultBox">
                        <strong>Tabela Utilizada:</strong> ${data.tabela_utilizada || 'N√£o dispon√≠vel'}
                    </div>
                `;
            } else if (selectedTest === 'rotas') {
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        ${data.c ? `
                            <div class="resultBox" style="background: #e8f5e9; border-color: #4caf50;">
                                <h4 style="color: #388e3c; margin-bottom: 10px;">Rota C - Aten√ß√£o Concentrada</h4>
                                <p style="font-size: 11px; color: #666; margin-bottom: 10px;">1¬™ Aplica√ß√£o</p>
                                <div><strong>Acertos:</strong> ${data.c.acertos}</div>
                                <div><strong>Erros:</strong> ${data.c.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.c.omissoes}</div>
                                <div><strong>PB:</strong> ${data.c.pb}</div>
                                ${data.c.percentil !== null ? `
                                    <div><strong>Percentil:</strong> ${data.c.percentil}</div>
                                    <div><strong>Classifica√ß√£o:</strong> ${data.c.classificacao}</div>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${data.a ? `
                            <div class="resultBox" style="background: #e3f2fd; border-color: #2196f3;">
                                <h4 style="color: #1976d2; margin-bottom: 10px;">Rota A - Aten√ß√£o Alternada</h4>
                                <p style="font-size: 11px; color: #666; margin-bottom: 10px;">2¬™ Aplica√ß√£o</p>
                                <div><strong>Acertos:</strong> ${data.a.acertos}</div>
                                <div><strong>Erros:</strong> ${data.a.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.a.omissoes}</div>
                                <div><strong>PB:</strong> ${data.a.pb}</div>
                                ${data.a.percentil !== null ? `
                                    <div><strong>Percentil:</strong> ${data.a.percentil}</div>
                                    <div><strong>Classifica√ß√£o:</strong> ${data.a.classificacao}</div>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${data.d ? `
                            <div class="resultBox" style="background: #f3e5f5; border-color: #9c27b0;">
                                <h4 style="color: #7b1fa2; margin-bottom: 10px;">Rota D - Aten√ß√£o Dividida</h4>
                                <p style="font-size: 11px; color: #666; margin-bottom: 10px;">3¬™ Aplica√ß√£o</p>
                                <div><strong>Acertos:</strong> ${data.d.acertos}</div>
                                <div><strong>Erros:</strong> ${data.d.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.d.omissoes}</div>
                                <div><strong>PB:</strong> ${data.d.pb}</div>
                                ${data.d.percentil !== null ? `
                                    <div><strong>Percentil:</strong> ${data.d.percentil}</div>
                                    <div><strong>Classifica√ß√£o:</strong> ${data.d.classificacao}</div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
                container.innerHTML = html;
            } else if (selectedTest === 'bpa2') {
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        ${data.alternada ? `
                            <div class="resultBox" style="background: #e3f2fd; border-color: #2196f3;">
                                <h4 style="color: #1976d2; margin-bottom: 10px;">AA - Aten√ß√£o Alternada</h4>
                                <div><strong>Acertos:</strong> ${data.alternada.acertos}</div>
                                <div><strong>Erros:</strong> ${data.alternada.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.alternada.omissoes}</div>
                                <div><strong>Pontos:</strong> ${data.alternada.pontos}</div>
                                ${data.alternada.percentil !== null && data.alternada.percentil !== undefined ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Percentil:</strong> ${data.alternada.percentil}</div>
                                        <div><strong>Classifica√ß√£o:</strong> ${data.alternada.classificacao}</div>
                                    </div>
                                ` : data.alternada.classificacao && data.alternada.classificacao !== 'Tabela normativa n√£o dispon√≠vel' ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Classifica√ß√£o:</strong> ${data.alternada.classificacao}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${data.concentrada ? `
                            <div class="resultBox" style="background: #e8f5e9; border-color: #4caf50;">
                                <h4 style="color: #388e3c; margin-bottom: 10px;">AC - Aten√ß√£o Concentrada</h4>
                                <div><strong>Acertos:</strong> ${data.concentrada.acertos}</div>
                                <div><strong>Erros:</strong> ${data.concentrada.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.concentrada.omissoes}</div>
                                <div><strong>Pontos:</strong> ${data.concentrada.pontos}</div>
                                ${data.concentrada.percentil !== null && data.concentrada.percentil !== undefined ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Percentil:</strong> ${data.concentrada.percentil}</div>
                                        <div><strong>Classifica√ß√£o:</strong> ${data.concentrada.classificacao}</div>
                                    </div>
                                ` : data.concentrada.classificacao && data.concentrada.classificacao !== 'Tabela normativa n√£o dispon√≠vel' ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Classifica√ß√£o:</strong> ${data.concentrada.classificacao}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${data.dividida ? `
                            <div class="resultBox" style="background: #f3e5f5; border-color: #9c27b0;">
                                <h4 style="color: #7b1fa2; margin-bottom: 10px;">AD - Aten√ß√£o Dividida</h4>
                                <div><strong>Acertos:</strong> ${data.dividida.acertos}</div>
                                <div><strong>Erros:</strong> ${data.dividida.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.dividida.omissoes}</div>
                                <div><strong>Pontos:</strong> ${data.dividida.pontos}</div>
                                ${data.dividida.percentil !== null && data.dividida.percentil !== undefined ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Percentil:</strong> ${data.dividida.percentil}</div>
                                        <div><strong>Classifica√ß√£o:</strong> ${data.dividida.classificacao}</div>
                                    </div>
                                ` : data.dividida.classificacao && data.dividida.classificacao !== 'Tabela normativa n√£o dispon√≠vel' ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Classifica√ß√£o:</strong> ${data.dividida.classificacao}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                    ${data.geral ? `
                        <div class="resultBox highlight" style="background: #fff3e0; border-color: #ff9800;">
                            <h4 style="color: #e65100; margin-bottom: 10px;">üìä Aten√ß√£o Geral</h4>
                            <div class="resultValue">${data.geral.pontos} pontos</div>
                            <p style="font-size: 12px; color: #666; margin: 5px 0;">Soma: AA + AC + AD</p>
                            ${data.geral.percentil !== null && data.geral.percentil !== undefined ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                    <div><strong>Percentil:</strong> ${data.geral.percentil}</div>
                                    <div><strong>Classifica√ß√£o:</strong> ${data.geral.classificacao}</div>
                                </div>
                            ` : data.geral.classificacao && data.geral.classificacao !== 'Tabela normativa n√£o dispon√≠vel' ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                    <div><strong>Classifica√ß√£o:</strong> ${data.geral.classificacao}</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                `;
                container.innerHTML = html;
            } else if (selectedTest === 'palografico') {
                console.log('üìä Exibindo resultado Palogr√°fico:', data);
                
                // Garantir que os valores n√£o sejam undefined/null
                const produtividade = data.produtividade !== null && data.produtividade !== undefined ? data.produtividade : 0;
                const nor = data.nor !== null && data.nor !== undefined ? data.nor : 0;
                const tamanhoMedio = data.tamanho?.media || data.tamanho_medio || null;
                const distanciaMedia = data.distancia_media || null;
                const impulsividade = data.impulsividade || null;
                const emotividade = data.emotividade !== null && data.emotividade !== undefined ? data.emotividade : 0;
                
                let html = `
                    <div class="resultBox highlight">
                        <div class="resultValue">${produtividade} palos</div>
                        <div class="resultLabel">Produtividade (5 minutos)</div>
                        ${data.classificacoes?.produtividade ? `<div style="margin-top: 5px; font-size: 12px; color: #666;">Classifica√ß√£o: ${data.classificacoes.produtividade}</div>` : ''}
                    </div>
                    <div class="resultBox">
                        <strong>NOR (N√≠vel de Oscila√ß√£o R√≠tmica):</strong> ${nor.toFixed(1)}
                        ${data.classificacoes?.nor ? ` <span style="color: #666;">(${data.classificacoes.nor})</span>` : ''}
                    </div>
                `;
                
                if (tamanhoMedio) {
                    html += `
                        <div class="resultBox">
                            <strong>Tamanho M√©dio dos Palos:</strong> ${tamanhoMedio} mm
                            ${data.classificacoes?.tamanho ? ` <span style="color: #666;">(${data.classificacoes.tamanho})</span>` : ''}
                        </div>
                    `;
                }
                
                if (distanciaMedia) {
                    html += `
                        <div class="resultBox">
                            <strong>Dist√¢ncia M√©dia entre Palos:</strong> ${distanciaMedia.toFixed(2)} mm
                            ${data.classificacoes?.distancia ? ` <span style="color: #666;">(${data.classificacoes.distancia})</span>` : ''}
                        </div>
                    `;
                }
                
                if (impulsividade !== null) {
                    html += `
                        <div class="resultBox">
                            <strong>Impulsividade:</strong> ${impulsividade.toFixed(1)} mm
                        </div>
                    `;
                }
                
                if (emotividade > 0) {
                    html += `
                        <div class="resultBox">
                            <strong>Emotividade (√çndice de Irregularidades):</strong> ${emotividade}/8
                        </div>
                    `;
                }
                
                // Campos adicionais do roteiro completo
                if (data.media_distancia_linhas) {
                    html += `<div class="resultBox"><strong>Dist√¢ncia M√©dia entre Linhas:</strong> ${data.media_distancia_linhas.toFixed(2)} mm</div>`;
                }
                if (data.media_margem_esquerda || data.media_margem_direita || data.media_margem_superior) {
                    html += `<div class="resultBox"><strong>Margens:</strong> Esquerda: ${data.media_margem_esquerda?.toFixed(2) || 'N/A'}mm | Direita: ${data.media_margem_direita?.toFixed(2) || 'N/A'}mm | Superior: ${data.media_margem_superior?.toFixed(2) || 'N/A'}mm</div>`;
                }
                if (data.porcentagem_ganchos) {
                    html += `<div class="resultBox"><strong>Porcentagem de Ganchos:</strong> ${data.porcentagem_ganchos.toFixed(1)}%</div>`;
                }
                if (data.media_inclinacao) {
                    html += `<div class="resultBox"><strong>Inclina√ß√£o M√©dia:</strong> ${data.media_inclinacao.toFixed(1)}¬∞</div>`;
                }
                
                // Interpreta√ß√£o completa
                if (data.interpretacao) {
                    html += `
                        <div class="resultBox" style="background: #f5f5f5; border-left: 4px solid #667eea;">
                            <strong style="display: block; margin-bottom: 10px;">üìã Interpreta√ß√£o Completa:</strong>
                            ${data.interpretacao.produtividade ? `
                                <div style="margin-bottom: 8px;">
                                    <strong>Produtividade:</strong> ${data.interpretacao.produtividade.interpretacao || 'N/A'}
                                </div>
                            ` : ''}
                            ${data.interpretacao.ritmo ? `
                                <div style="margin-bottom: 8px;">
                                    <strong>Ritmo:</strong> ${data.interpretacao.ritmo.interpretacao || 'N/A'}
                                </div>
                            ` : ''}
                            ${data.interpretacao.resumo_contextualizado ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                    <strong>Resumo Contextualizado:</strong><br>
                                    ${data.interpretacao.resumo_contextualizado}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                html += `
                    <div class="resultBox" style="background: #e8f5e9; border-color: #4caf50;">
                        <strong>Tabela Normativa Utilizada:</strong> ${data.tabela_utilizada || 'N√£o dispon√≠vel'}
                    </div>
                `;
                
                container.innerHTML = html;
            } else if (selectedTest === 'memoria') {
                container.innerHTML = `
                    <div class="resultBox highlight">
                        <div class="resultValue">${data.evocacao_tardia} itens</div>
                        <div class="resultLabel">Evoca√ß√£o Tardia</div>
                    </div>
                    <div class="resultBox">
                        <strong>Reten√ß√£o:</strong> ${data.retencao} itens (${data.percentual_retencao}%)
                        ${data.classificacoes?.retencao ? ` (${data.classificacoes.retencao})` : ''}
                    </div>
                    ${data.reconhecimento !== undefined ? `
                        <div class="resultBox">
                            <strong>Reconhecimento:</strong> ${data.reconhecimento} itens
                            ${data.classificacoes?.reconhecimento ? ` (${data.classificacoes.reconhecimento})` : ''}
                        </div>
                    ` : ''}
                `;
            }
        }

        // Iniciar novo teste
        function iniciarNovo() {
            currentStep = 1;
            selectedTest = null;
            resultadoCalculado = null;
            document.querySelectorAll('.testCard').forEach(c => c.classList.remove('selected'));
            document.getElementById('manualForm').style.display = 'none';
            document.getElementById('imagemForm').style.display = 'none';
            atualizarTimeline(1);
            mostrarSection(1);
        }

        // Quando teste √© selecionado, avan√ßar automaticamente
        document.querySelectorAll('.testCard').forEach(card => {
            card.addEventListener('click', () => {
                setTimeout(() => avancarStep(2), 300);
            });
        });

        // Mostrar formul√°rio manual quando avan√ßar para step 2
        const originalAvancarStep = avancarStep;
        avancarStep = function(step) {
            originalAvancarStep(step);
            if (step === 2 && inputMethod === 'manual') {
                mostrarFormManual();
            }
        };
    </script>
</body>
</html>

