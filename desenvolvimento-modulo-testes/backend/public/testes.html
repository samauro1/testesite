<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo de Testes - Corre√ß√£o Automatizada</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß™</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 40px;
        }

        /* Timeline Multi-Step */
        .timeline {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 20px;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            z-index: 0;
        }

        .timelineStep {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .timelineCircle {
            width: 40px;
            height: 40px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .timelineStep.active .timelineCircle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .timelineStep.completed .timelineCircle {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .timelineLabel {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }

        /* Seletor de Teste */
        .testSelector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .testCard {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .testCard:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .testCard.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .testCard h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .testCard p {
            color: #666;
            font-size: 14px;
        }

        /* Formul√°rios */
        .formSection {
            display: none;
        }

        .formSection.active {
            display: block;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Bot√µes */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .buttonGroup {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        /* Resultados */
        .resultBox {
            background: #f5f7fa;
            padding: 20px;
            border-left: 4px solid #667eea;
            border-radius: 5px;
            margin: 15px 0;
        }

        .resultBox.highlight {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left-color: #764ba2;
        }

        .resultValue {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .resultLabel {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Upload de Imagem */
        .imageUploadArea {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .imageUploadArea:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .imageUploadArea.dragover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }

        .imagePreview {
            max-width: 100%;
            max-height: 400px;
            margin-top: 20px;
            border-radius: 8px;
        }

        /* Tabelas Normativas */
        .tableContainer {
            overflow-x: auto;
            margin: 20px 0;
        }

        .normativeTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .normativeTable th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .normativeTable td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .normativeTable tr:hover {
            background: #f5f7fa;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .timeline {
                flex-direction: column;
            }
            
            .timeline::before {
                left: 20px;
                top: 0;
                width: 2px;
                height: 100%;
            }
            
            .timelineStep {
                margin-bottom: 30px;
                text-align: left;
                padding-left: 60px;
            }
            
            .timelineCircle {
                position: absolute;
                left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ M√≥dulo de Corre√ß√£o de Testes</h1>
            <p>Sistema automatizado de corre√ß√£o e interpreta√ß√£o</p>
        </div>

        <div class="content">
            <!-- Timeline -->
            <div class="timeline">
                <div class="timelineStep" id="step1">
                    <div class="timelineCircle">1</div>
                    <div class="timelineLabel">Selecionar Teste</div>
                </div>
                <div class="timelineStep" id="step2">
                    <div class="timelineCircle">2</div>
                    <div class="timelineLabel">Inserir Dados</div>
                </div>
                <div class="timelineStep" id="step3">
                    <div class="timelineCircle">3</div>
                    <div class="timelineLabel">Tabela Normativa</div>
                </div>
                <div class="timelineStep" id="step4">
                    <div class="timelineCircle">4</div>
                    <div class="timelineLabel">Resultado</div>
                </div>
            </div>

            <!-- Step 1: Sele√ß√£o de Teste -->
            <div class="formSection active" id="section1">
                <h2>Selecione o Teste</h2>
                <div class="testSelector">
                    <div class="testCard" data-test="ac">
                        <h3>üìä Teste AC</h3>
                        <p>Aten√ß√£o Concentrada<br>Acertos, Erros, Omiss√µes</p>
                    </div>
                    <div class="testCard" data-test="beta-iii">
                        <h3>üß© BETA-III</h3>
                        <p>Racioc√≠nio Matricial<br>0-25 acertos</p>
                    </div>
                    <div class="testCard" data-test="bpa2">
                        <h3>üëÅÔ∏è BPA-2</h3>
                        <p>Aten√ß√£o<br>Alternada, Concentrada, Dividida</p>
                    </div>
                    <div class="testCard" data-test="rotas">
                        <h3>üõ£Ô∏è Rotas de Aten√ß√£o</h3>
                        <p>Rotas A, D e C</p>
                    </div>
                    <div class="testCard" data-test="memore">
                        <h3>üß† MEMORE</h3>
                        <p>Mem√≥ria<br>VP, VN, FP, FN</p>
                    </div>
                    <div class="testCard" data-test="mig">
                        <h3>üî¢ MIG</h3>
                        <p>Avalia√ß√£o Psicol√≥gica<br>28 quest√µes</p>
                    </div>
                    <div class="testCard" data-test="mvt">
                        <h3>üöó MVT</h3>
                        <p>Mem√≥ria Visual Tr√¢nsito<br>Acertos, Erros, Omiss√£o</p>
                    </div>
                    <div class="testCard" data-test="r1">
                        <h3>üí≠ R-1</h3>
                        <p>Racioc√≠nio<br>0-40 acertos</p>
                    </div>
                    <div class="testCard" data-test="palografico">
                        <h3>‚úçÔ∏è Palogr√°fico</h3>
                        <p>Roteiro Completo<br>13 vari√°veis quantitativas</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: Inser√ß√£o de Dados -->
            <div class="formSection" id="section2">
                <h2>Inserir Dados do Teste</h2>
                <p>Escolha o m√©todo de entrada:</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <button class="btn" onclick="setInputMethod('manual')">
                        ‚úèÔ∏è Entrada Manual
                    </button>
                    <button class="btn" onclick="setInputMethod('imagem')">
                        üì∑ Analisar Imagem (IA)
                    </button>
                </div>

                <!-- Formul√°rio Manual -->
                <div id="manualForm" style="display: none;">
                    <!-- AC Form -->
                    <div id="acFormManual" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Acertos (A):</label>
                                <input type="number" id="acertos" min="0" value="147">
                            </div>
                            <div class="form-group">
                                <label>Erros (E):</label>
                                <input type="number" id="erros" min="0" value="1">
                            </div>
                            <div class="form-group">
                                <label>Omiss√µes (O):</label>
                                <input type="number" id="omissoes" min="0" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Regi√£o:</label>
                                <select id="acRegiao">
                                    <option value="">Selecione</option>
                                    <option value="Sul">Sul</option>
                                    <option value="Sudeste" selected>Sudeste</option>
                                    <option value="Centro-oeste">Centro-Oeste</option>
                                    <option value="Nordeste">Nordeste</option>
                                    <option value="Norte">Norte</option>
                                    <option value="Geral">Geral</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Escolaridade:</label>
                                <select id="acEscolaridade">
                                    <option value="Total">Total</option>
                                    <option value="Ensino Fundamental">Ensino Fundamental</option>
                                    <option value="Ensino M√©dio">Ensino M√©dio</option>
                                    <option value="Ensino Superior" selected>Ensino Superior</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Idade:</label>
                                <input type="number" id="acIdade" min="18" max="64" placeholder="26">
                            </div>
                        </div>
                    </div>

                    <!-- Palogr√°fico Form -->
                    <div id="palograficoFormManual" style="display: none;">
                        <h3>Palos por Minuto (5 minutos)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Minuto 1:</label>
                                <input type="number" id="tempo1" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Minuto 2:</label>
                                <input type="number" id="tempo2" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Minuto 3:</label>
                                <input type="number" id="tempo3" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Minuto 4:</label>
                                <input type="number" id="tempo4" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Minuto 5:</label>
                                <input type="number" id="tempo5" min="0" value="0">
                            </div>
                        </div>
                        <h3 style="margin-top: 30px;">Tamanhos dos Palos (mm) - Opcional</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Maiores Palos (separados por v√≠rgula):</label>
                                <input type="text" id="tamanhosMaiores" placeholder="10.5, 11.2, 10.8">
                            </div>
                            <div class="form-group">
                                <label>Menores Palos (separados por v√≠rgula):</label>
                                <input type="text" id="tamanhosMenores" placeholder="8.5, 9.0, 8.7">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Dist√¢ncia Total (mm) - Opcional:</label>
                                <input type="number" id="distanciaTotal" step="0.01" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Regi√£o:</label>
                                <select id="palograficoRegiao">
                                    <option value="Sudeste" selected>Sudeste</option>
                                    <option value="Sul">Sul</option>
                                    <option value="Nordeste">Nordeste</option>
                                    <option value="Norte">Norte</option>
                                    <option value="Centro-oeste">Centro-Oeste</option>
                                    <option value="Geral">Geral</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sexo:</label>
                                <select id="palograficoSexo">
                                    <option value="M">Masculino</option>
                                    <option value="F">Feminino</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Escolaridade:</label>
                                <select id="palograficoEscolaridade">
                                    <option value="Fundamental">Fundamental</option>
                                    <option value="M√©dio">M√©dio</option>
                                    <option value="Superior" selected>Superior</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Rotas de Aten√ß√£o Form -->
                    <div id="rotasFormManual" style="display: none;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üõ£Ô∏è Rotas de Aten√ß√£o (C, A, D)</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 14px; text-align: center;">Ordem de aplica√ß√£o: Concentrada ‚Üí Alternada ‚Üí Dividida</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                            <!-- Rota C - Aten√ß√£o Concentrada (PRIMEIRA) -->
                            <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">C</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #388e3c; margin: 0;">Rota C - Aten√ß√£o Concentrada</h4>
                                    <p style="font-size: 12px; color: #666; margin-top: 5px;">1¬™ Aplica√ß√£o</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosRotaC" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosRotaC" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesRotaC" min="0" max="50" value="0">
                                </div>
                            </div>

                            <!-- Rota A - Aten√ß√£o Alternada (SEGUNDA) -->
                            <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #2196f3; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">A</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #1976d2; margin: 0;">Rota A - Aten√ß√£o Alternada</h4>
                                    <p style="font-size: 12px; color: #666; margin-top: 5px;">2¬™ Aplica√ß√£o</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosRotaA" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosRotaA" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesRotaA" min="0" max="50" value="0">
                                </div>
                            </div>

                            <!-- Rota D - Aten√ß√£o Dividida (TERCEIRA) -->
                            <div style="background: #f3e5f5; border: 2px solid #9c27b0; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #9c27b0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">D</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #7b1fa2; margin: 0;">Rota D - Aten√ß√£o Dividida</h4>
                                    <p style="font-size: 12px; color: #666; margin-top: 5px;">3¬™ Aplica√ß√£o</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosRotaD" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosRotaD" min="0" max="50" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesRotaD" min="0" max="50" value="0">
                                </div>
                            </div>
                        </div>


                        <!-- Seletor de Tabela Normativa -->
                        <div style="background: #f5f5f5; border: 2px solid #ddd; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label style="font-weight: bold; color: #333; margin-bottom: 10px; display: block;">
                                    üìã Tabela Normativa (Opcional):
                                </label>
                                <select id="rotasTabelaId" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                                    <option value="">Selecione uma tabela (opcional - ser√° buscada automaticamente se n√£o selecionada)</option>
                                </select>
                                <p style="color: #666; font-size: 12px; margin-top: 8px; margin-bottom: 0;">
                                    Se n√£o selecionar, o sistema tentar√° buscar uma tabela padr√£o automaticamente.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- BPA-2 Form -->
                    <div id="bpa2FormManual" style="display: none;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üëÅÔ∏è BPA-2 - Bateria de Provas de Aten√ß√£o</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 14px; text-align: center;">Teste de aten√ß√£o com tr√™s modalidades: Alternada (AA), Concentrada (AC) e Dividida (AD)</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                            <!-- Aten√ß√£o Alternada (AA) -->
                            <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #2196f3; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">AA</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #1976d2; margin: 0;">Aten√ß√£o Alternada</h4>
                                    <p style="font-size: 11px; color: #666; margin-top: 5px;">2 min 30 seg</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosAlternada" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosAlternada" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesAlternada" min="0" value="0">
                                </div>
                            </div>

                            <!-- Aten√ß√£o Concentrada (AC) -->
                            <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">AC</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #388e3c; margin: 0;">Aten√ß√£o Concentrada</h4>
                                    <p style="font-size: 11px; color: #666; margin-top: 5px;">2 minutos</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosConcentrada" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosConcentrada" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesConcentrada" min="0" value="0">
                                </div>
                            </div>

                            <!-- Aten√ß√£o Dividida (AD) -->
                            <div style="background: #f3e5f5; border: 2px solid #9c27b0; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="width: 50px; height: 50px; background: #9c27b0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                                        <span style="color: white; font-weight: bold; font-size: 20px;">AD</span>
                                    </div>
                                    <h4 style="font-size: 16px; font-weight: bold; color: #7b1fa2; margin: 0;">Aten√ß√£o Dividida</h4>
                                    <p style="font-size: 11px; color: #666; margin-top: 5px;">4 minutos</p>
                                </div>
                                <div class="form-group">
                                    <label>Acertos:</label>
                                    <input type="number" id="acertosDividida" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Erros:</label>
                                    <input type="number" id="errosDividida" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Omiss√µes:</label>
                                    <input type="number" id="omissoesDividida" min="0" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Seletor de Tabela Normativa e Crit√©rios -->
                        <div style="background: #f5f5f5; border: 2px solid #ddd; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="font-weight: bold; color: #333; margin-bottom: 10px; display: block;">
                                    üìã Tabela Normativa (Opcional):
                                </label>
                                <select id="bpa2TabelaId" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                                    <option value="">Selecione uma tabela (opcional - ser√° buscada automaticamente se n√£o selecionada)</option>
                                </select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label style="font-weight: bold; color: #333; margin-bottom: 8px; display: block; font-size: 13px;">
                                        üë§ Idade/Faixa Et√°ria (Opcional):
                                    </label>
                                    <select id="bpa2Idade" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                                        <option value="">Selecione a idade (opcional)</option>
                                        <option value="6 anos">6 anos</option>
                                        <option value="7 anos">7 anos</option>
                                        <option value="8 anos">8 anos</option>
                                        <option value="9 anos">9 anos</option>
                                        <option value="10 anos">10 anos</option>
                                        <option value="11 anos">11 anos</option>
                                        <option value="12 anos">12 anos</option>
                                        <option value="13 anos">13 anos</option>
                                        <option value="14 anos">14 anos</option>
                                        <option value="15-17 anos">15-17 anos</option>
                                        <option value="18-20 anos">18-20 anos</option>
                                        <option value="21-30 anos">21-30 anos</option>
                                        <option value="31-40 anos">31-40 anos</option>
                                        <option value="41-50 anos">41-50 anos</option>
                                        <option value="51-60 anos">51-60 anos</option>
                                        <option value="61-70 anos">61-70 anos</option>
                                        <option value="71-80 anos">71-80 anos</option>
                                        <option value="81 anos ou mais">81 anos ou mais</option>
                                        <option value="Amostra Total">Amostra Total (padr√£o)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="font-weight: bold; color: #333; margin-bottom: 8px; display: block; font-size: 13px;">
                                        üéì Escolaridade (Opcional):
                                    </label>
                                    <select id="bpa2Escolaridade" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                                        <option value="">Selecione a escolaridade (opcional)</option>
                                        <option value="N√£o alfabetizado">N√£o alfabetizado</option>
                                        <option value="Ensino Fundamental">Ensino Fundamental</option>
                                        <option value="Ensino M√©dio/T√©cnico/Profissionalizante">Ensino M√©dio/T√©cnico/Profissionalizante</option>
                                        <option value="Ensino Superior e/ou P√≥s-Gradua√ß√£o">Ensino Superior e/ou P√≥s-Gradua√ß√£o</option>
                                        <option value="Amostra Total">Amostra Total (padr√£o)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <p style="color: #666; font-size: 12px; margin-top: 12px; margin-bottom: 0;">
                                üí° <strong>Dica:</strong> Selecione idade OU escolaridade para usar normas espec√≠ficas. Se n√£o selecionar, ser√° usado "Amostra Total".
                                <br>‚ö†Ô∏è <strong>Importante:</strong> Se selecionar uma tabela por idade, escolha tamb√©m a idade. Se por escolaridade, escolha a escolaridade.
                            </p>
                        </div>
                    </div>

                    <!-- Mem√≥ria Form -->
                    <div id="memoriaFormManual" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Evoca√ß√£o Imediata:</label>
                                <input type="number" id="evocacaoImediata" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Evoca√ß√£o Tardia:</label>
                                <input type="number" id="evocacaoTardia" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Reten√ß√£o (opcional):</label>
                                <input type="number" id="retencao" min="0" placeholder="Ser√° calculada">
                            </div>
                            <div class="form-group">
                                <label>Reconhecimento (opcional):</label>
                                <input type="number" id="reconhecimento" min="0" placeholder="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Regi√£o:</label>
                                <select id="memoriaRegiao">
                                    <option value="Sudeste" selected>Sudeste</option>
                                    <option value="Sul">Sul</option>
                                    <option value="Nordeste">Nordeste</option>
                                    <option value="Norte">Norte</option>
                                    <option value="Centro-oeste">Centro-Oeste</option>
                                    <option value="Geral">Geral</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Escolaridade:</label>
                                <select id="memoriaEscolaridade">
                                    <option value="Fundamental">Fundamental</option>
                                    <option value="M√©dio">M√©dio</option>
                                    <option value="Superior" selected>Superior</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Idade:</label>
                                <input type="number" id="memoriaIdade" min="18" max="100" placeholder="26">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload de Imagem -->
                <div id="imagemForm" style="display: none;">
                    <div class="imageUploadArea" id="imageUploadArea">
                        <p>üì∑ Clique ou arraste uma imagem do teste aqui</p>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        <img id="imagePreview" class="imagePreview" style="display: none;">
                        <p id="imageStatus" style="margin-top: 10px; color: #666;"></p>
                    </div>
                </div>

                <div class="buttonGroup">
                    <button class="btn btn-secondary" onclick="voltarStep(1)">Voltar</button>
                    <button class="btn" onclick="calcularTeste()">Calcular</button>
                </div>
            </div>

            <!-- Step 3: Sele√ß√£o de Tabela -->
            <div class="formSection" id="section3">
                <h2>Tabela Normativa</h2>
                <div id="tabelaInfo" style="margin: 20px 0;">
                    <p>Tabela selecionada automaticamente com base nos crit√©rios informados.</p>
                </div>
                <div class="buttonGroup">
                    <button class="btn btn-secondary" onclick="voltarStep(2)">Voltar</button>
                    <button class="btn" onclick="avancarStep(4)">Ver Resultado</button>
                </div>
            </div>

            <!-- Step 4: Resultado -->
            <div class="formSection" id="section4">
                <h2>Resultado do Teste</h2>
                <div id="resultadoContainer"></div>
                <div class="buttonGroup">
                    <button class="btn btn-secondary" onclick="voltarStep(3)">Voltar</button>
                    <button class="btn btn-success" onclick="iniciarNovo()">Novo Teste</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3002';
        let currentStep = 1;
        let selectedTest = null;
        let inputMethod = 'manual';
        let resultadoCalculado = null;

        // Sele√ß√£o de teste
        document.querySelectorAll('.testCard').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.testCard').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedTest = card.dataset.test;
                atualizarTimeline(1);
            });
        });

        // Avan√ßar para pr√≥ximo passo
        function avancarStep(step) {
            if (step === 2 && !selectedTest) {
                alert('Por favor, selecione um teste primeiro');
                return;
            }
            currentStep = step;
            atualizarTimeline(step);
            mostrarSection(step);
        }

        // Voltar para passo anterior
        function voltarStep(step) {
            currentStep = step;
            atualizarTimeline(step);
            mostrarSection(step);
        }

        // Atualizar timeline
        function atualizarTimeline(step) {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
        }

        // Mostrar se√ß√£o
        function mostrarSection(step) {
            document.querySelectorAll('.formSection').forEach(s => s.classList.remove('active'));
            document.getElementById(`section${step}`).classList.add('active');
        }

        // M√©todo de entrada
        function setInputMethod(method) {
            inputMethod = method;
            document.getElementById('manualForm').style.display = method === 'manual' ? 'block' : 'none';
            document.getElementById('imagemForm').style.display = method === 'imagem' ? 'block' : 'none';
            
            if (method === 'manual') {
                mostrarFormManual();
            }
        }

        // Mostrar formul√°rio manual correto
        function mostrarFormManual() {
            document.getElementById('acFormManual').style.display = selectedTest === 'ac' ? 'block' : 'none';
            document.getElementById('palograficoFormManual').style.display = selectedTest === 'palografico' ? 'block' : 'none';
            document.getElementById('rotasFormManual').style.display = selectedTest === 'rotas' ? 'block' : 'none';
            document.getElementById('bpa2FormManual').style.display = selectedTest === 'bpa2' ? 'block' : 'none';
            document.getElementById('memoriaFormManual').style.display = selectedTest === 'memoria' ? 'block' : 'none';
            
            // Carregar tabelas quando o formul√°rio de Rotas ou BPA-2 for exibido
            if (selectedTest === 'rotas') {
                // Aguardar um pouco para garantir que o DOM est√° pronto
                setTimeout(() => carregarTabelasRotas(), 100);
            }
            if (selectedTest === 'bpa2') {
                // Aguardar um pouco para garantir que o DOM est√° pronto
                setTimeout(() => carregarTabelasBPA2(), 100);
            }
            
            // Outros testes (por enquanto sem formul√°rios espec√≠ficos, mas preparados)
            // TODO: Adicionar formul√°rios para BETA-III, MEMORE, MIG, MVT, R-1
        }

        // Carregar tabelas normativas para BPA-2
        async function carregarTabelasBPA2() {
            const select = document.getElementById('bpa2TabelaId');
            if (!select) {
                console.error('‚ùå Elemento bpa2TabelaId n√£o encontrado no DOM');
                return;
            }

            console.log('üîç Iniciando carregamento de tabelas BPA-2...');

            try {
                // Adicionar timestamp para evitar cache
                const timestamp = new Date().getTime();
                const url = `${API_BASE}/api/bpa2/tabelas?_t=${timestamp}`;
                console.log('üì° Fazendo requisi√ß√£o para:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                console.log('üì• Resposta recebida. Status:', response.status, response.statusText);
                
                // Verificar se a resposta √© v√°lida (n√£o 404)
                if (!response.ok && response.status === 404) {
                    console.warn('‚ö†Ô∏è Rota /api/bpa2/tabelas n√£o encontrada (404). Continuando sem tabelas.');
                    console.warn('üí° Dica: Tente atualizar a p√°gina com Ctrl+F5 para limpar o cache');
                    select.innerHTML = '<option value="">Tabela normativa opcional - ser√° calculado sem tabela se n√£o selecionada</option>';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üìä Dados recebidos:', JSON.stringify(data, null, 2));

                // Limpar op√ß√µes existentes
                select.innerHTML = '<option value="">Selecione uma tabela (opcional - ser√° buscada automaticamente se n√£o selecionada)</option>';

                if (data.success && data.data && data.data.tabelas && data.data.tabelas.length > 0) {
                    console.log(`‚úÖ Encontradas ${data.data.tabelas.length} tabela(s) para popular o dropdown`);
                    
                    // Agrupar tabelas por crit√©rio
                    const tabelasPorCriterio = {};
                    data.data.tabelas.forEach(tabela => {
                        const criterio = tabela.criterio || 'geral';
                        if (!tabelasPorCriterio[criterio]) {
                            tabelasPorCriterio[criterio] = [];
                        }
                        tabelasPorCriterio[criterio].push(tabela);
                    });
                    
                    // Adicionar op√ß√µes agrupadas por crit√©rio
                    Object.keys(tabelasPorCriterio).sort().forEach(criterio => {
                        const tabelasCriterio = tabelasPorCriterio[criterio];
                        
                        // Adicionar grupo (optgroup) se houver mais de uma tabela por crit√©rio
                        if (tabelasCriterio.length > 1) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = `üìã Crit√©rio: ${criterio.charAt(0).toUpperCase() + criterio.slice(1)} (${tabelasCriterio.length} tabelas)`;
                            optgroup.dataset.criterio = criterio;
                            
                            tabelasCriterio.forEach((tabela, index) => {
                                console.log(`  ${index + 1}. ID: ${tabela.id}, Nome: ${tabela.nome}, Crit√©rio: ${criterio}`);
                                const option = document.createElement('option');
                                option.value = tabela.id;
                                option.dataset.criterio = criterio;
                                const nomeDisplay = tabela.nome || 'Tabela sem nome';
                                const versaoDisplay = tabela.versao ? ` (v${tabela.versao})` : '';
                                option.textContent = `${nomeDisplay}${versaoDisplay}`;
                                optgroup.appendChild(option);
                            });
                            
                            select.appendChild(optgroup);
                        } else {
                            // Tabela √∫nica sem crit√©rio ou crit√©rio √∫nico
                            tabelasCriterio.forEach((tabela, index) => {
                                console.log(`  ${index + 1}. ID: ${tabela.id}, Nome: ${tabela.nome}, Crit√©rio: ${criterio}`);
                                const option = document.createElement('option');
                                option.value = tabela.id;
                                option.dataset.criterio = criterio;
                                const nomeDisplay = tabela.nome || 'Tabela sem nome';
                                const versaoDisplay = tabela.versao ? ` (v${tabela.versao})` : '';
                                const criterioDisplay = criterio !== 'geral' ? ` - ${criterio}` : '';
                                option.textContent = `${nomeDisplay}${versaoDisplay}${criterioDisplay}`;
                                select.appendChild(option);
                            });
                        }
                    });
                    
                    console.log(`‚úÖ ${data.data.tabelas.length} tabela(s) adicionada(s) ao dropdown BPA-2`);
                    console.log(`‚úÖ Dropdown agora tem ${select.options.length} op√ß√£o(√µes)`);
                } else {
                    console.warn('‚ö†Ô∏è Nenhuma tabela encontrada na resposta:', data);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhuma tabela dispon√≠vel - calcule sem tabela (apenas pontos)';
                    option.disabled = true;
                    select.appendChild(option);
                    console.log('‚ö†Ô∏è Nenhuma tabela normativa dispon√≠vel para BPA-2');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar tabelas de BPA-2:', error);
                console.error('   Stack:', error.stack);
                // N√£o bloquear - permitir c√°lculo sem tabela
                select.innerHTML = '<option value="">Tabela normativa opcional - ser√° calculado sem tabela se n√£o selecionada</option>';
                console.log('‚ÑπÔ∏è Continuando sem tabelas. C√°lculo ser√° feito apenas com pontos brutos.');
            }
        }

        // Carregar tabelas normativas para Rotas
        async function carregarTabelasRotas() {
            const select = document.getElementById('rotasTabelaId');
            if (!select) return;

            try {
                // Adicionar timestamp para evitar cache
                const timestamp = new Date().getTime();
                const response = await fetch(`${API_BASE}/api/rotas/tabelas?_t=${timestamp}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const data = await response.json();

                // Limpar op√ß√µes existentes (exceto a primeira)
                select.innerHTML = '<option value="">Selecione uma tabela (opcional - ser√° buscada automaticamente se n√£o selecionada)</option>';

                if (data.success && data.data.tabelas && data.data.tabelas.length > 0) {
                    data.data.tabelas.forEach(tabela => {
                        const option = document.createElement('option');
                        option.value = tabela.id;
                        option.textContent = `${tabela.nome}${tabela.versao ? ' (v' + tabela.versao + ')' : ''}${tabela.criterio ? ' - ' + tabela.criterio : ''}`;
                        select.appendChild(option);
                    });
                    console.log(`‚úÖ ${data.data.tabelas.length} tabela(s) carregada(s) para Rotas`);
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhuma tabela dispon√≠vel - calcule sem tabela (apenas PBs)';
                    option.disabled = true;
                    select.appendChild(option);
                    console.log('‚ö†Ô∏è Nenhuma tabela normativa dispon√≠vel para Rotas');
                }
            } catch (error) {
                console.error('Erro ao carregar tabelas de Rotas:', error);
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Erro ao carregar tabelas - ser√° calculado sem tabela';
                option.disabled = true;
                select.appendChild(option);
            }
        }

        // Upload de imagem
        document.getElementById('imageUploadArea').addEventListener('click', () => {
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Image = e.target.result;
                    document.getElementById('imagePreview').src = base64Image;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imageStatus').textContent = '‚è≥ Analisando imagem com IA...';
                    
                    // Analisar imagem
                    try {
                        const response = await fetch(`${API_BASE}/api/imagem/analisar-base64`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                imagem_base64: base64Image,
                                tipo_teste: selectedTest || 'atencao'
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            const resultado = data.data;
                            document.getElementById('imageStatus').innerHTML = `
                                ‚úÖ An√°lise conclu√≠da! Confian√ßa: ${resultado.confiancaIA}%<br>
                                üìä Dados extra√≠dos: ${JSON.stringify(resultado.dadosExtraidos, null, 2)}
                            `;
                            
                            // Preencher formul√°rio automaticamente
                            preencherFormularioComDados(resultado.dadosExtraidos);
                        } else {
                            document.getElementById('imageStatus').textContent = '‚ùå Erro: ' + (data.error || data.message);
                        }
                    } catch (error) {
                        console.error('Erro ao analisar:', error);
                        document.getElementById('imageStatus').textContent = '‚ùå Erro ao analisar imagem: ' + error.message;
                    }
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Preencher formul√°rio com dados extra√≠dos
        function preencherFormularioComDados(dados) {
            if (selectedTest === 'ac') {
                if (dados.acertos) document.getElementById('acertos').value = dados.acertos;
                if (dados.erros) document.getElementById('erros').value = dados.erros;
                if (dados.omissoes) document.getElementById('omissoes').value = dados.omissoes;
            } else if (selectedTest === 'palografico') {
                if (dados.tempos && Array.isArray(dados.tempos)) {
                    document.getElementById('tempo1').value = dados.tempos[0] || 0;
                    document.getElementById('tempo2').value = dados.tempos[1] || 0;
                    document.getElementById('tempo3').value = dados.tempos[2] || 0;
                    document.getElementById('tempo4').value = dados.tempos[3] || 0;
                    document.getElementById('tempo5').value = dados.tempos[4] || 0;
                }
                if (dados.tamanho_medio) {
                    // Aproximar tamanhos maiores e menores
                    document.getElementById('tamanhosMaiores').value = (dados.tamanho_medio + 1).toFixed(1);
                    document.getElementById('tamanhosMenores').value = (dados.tamanho_medio - 1).toFixed(1);
                }
                if (dados.distancia_media) {
                    document.getElementById('distanciaTotal').value = (dados.distancia_media * 100).toFixed(2);
                }
            } else if (selectedTest === 'memoria') {
                if (dados.evocacao_imediata) document.getElementById('evocacaoImediata').value = dados.evocacao_imediata;
                if (dados.evocacao_tardia) document.getElementById('evocacaoTardia').value = dados.evocacao_tardia;
                if (dados.retencao) document.getElementById('retencao').value = dados.retencao;
                if (dados.reconhecimento) document.getElementById('reconhecimento').value = dados.reconhecimento;
            }
        }

        // Calcular teste
        async function calcularTeste() {
            if (!selectedTest) {
                alert('Por favor, selecione um teste');
                return;
            }

            try {
                let response;
                
                if (selectedTest === 'ac') {
                    const acertos = parseInt(document.getElementById('acertos').value);
                    const erros = parseInt(document.getElementById('erros').value);
                    const omissoes = parseInt(document.getElementById('omissoes').value);
                    const regiao = document.getElementById('acRegiao').value;
                    const escolaridade = document.getElementById('acEscolaridade').value;
                    const idade = document.getElementById('acIdade').value ? parseInt(document.getElementById('acIdade').value) : null;

                    response = await fetch(`${API_BASE}/api/ac/calcular`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ acertos, erros, omissoes, regiao, escolaridade, idade })
                    });
                } else if (selectedTest === 'palografico') {
                    const tempos = [
                        parseInt(document.getElementById('tempo1').value) || 0,
                        parseInt(document.getElementById('tempo2').value) || 0,
                        parseInt(document.getElementById('tempo3').value) || 0,
                        parseInt(document.getElementById('tempo4').value) || 0,
                        parseInt(document.getElementById('tempo5').value) || 0
                    ];
                    
                    const tamanhosMaioresStr = document.getElementById('tamanhosMaiores').value;
                    const tamanhosMenoresStr = document.getElementById('tamanhosMenores').value;
                    const tamanhosMaiores = tamanhosMaioresStr ? tamanhosMaioresStr.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : null;
                    const tamanhosMenores = tamanhosMenoresStr ? tamanhosMenoresStr.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : null;
                    
                    // ROTEIRO COMPLETO - Todos os 13 campos
                    const body = {
                        tempos,
                        tamanhos_maiores: tamanhosMaiores,
                        tamanhos_menores: tamanhosMenores,
                        distancia_total: document.getElementById('distanciaTotal').value ? parseFloat(document.getElementById('distanciaTotal').value) : null,
                        produtividade: document.getElementById('produtividade').value ? parseInt(document.getElementById('produtividade').value) : null,
                        nor: document.getElementById('nor').value ? parseFloat(document.getElementById('nor').value) : null,
                        media_tamanho_palos: document.getElementById('mediaTamanhoPalos').value ? parseFloat(document.getElementById('mediaTamanhoPalos').value) : null,
                        distancia_media: document.getElementById('distanciaMedia').value ? parseFloat(document.getElementById('distanciaMedia').value) : null,
                        impulsividade: document.getElementById('impulsividade').value ? parseFloat(document.getElementById('impulsividade').value) : null,
                        media_distancia_linhas: document.getElementById('mediaDistanciaLinhas').value ? parseFloat(document.getElementById('mediaDistanciaLinhas').value) : null,
                        media_margem_esquerda: document.getElementById('mediaMargemEsquerda').value ? parseFloat(document.getElementById('mediaMargemEsquerda').value) : null,
                        media_margem_direita: document.getElementById('mediaMargemDireita').value ? parseFloat(document.getElementById('mediaMargemDireita').value) : null,
                        media_margem_superior: document.getElementById('mediaMargemSuperior').value ? parseFloat(document.getElementById('mediaMargemSuperior').value) : null,
                        porcentagem_ganchos: document.getElementById('porcentagemGanchos').value ? parseFloat(document.getElementById('porcentagemGanchos').value) : null,
                        media_inclinacao: document.getElementById('mediaInclinacao').value ? parseFloat(document.getElementById('mediaInclinacao').value) : null,
                        media_direcao_linhas: document.getElementById('mediaDirecaoLinhas').value ? parseFloat(document.getElementById('mediaDirecaoLinhas').value) : null,
                        total_emotividade: document.getElementById('totalEmotividade').value ? parseInt(document.getElementById('totalEmotividade').value) : null,
                        regiao: document.getElementById('palograficoRegiao').value,
                        sexo: document.getElementById('palograficoSexo').value,
                        escolaridade: document.getElementById('palograficoEscolaridade').value,
                        idade: document.getElementById('palograficoIdade').value ? parseInt(document.getElementById('palograficoIdade').value) : null,
                        contexto: 'transito'
                    };

                    response = await fetch(`${API_BASE}/api/palografico/calcular`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                } else if (selectedTest === 'rotas') {
                    const acertosRotaA = parseInt(document.getElementById('acertosRotaA').value) || 0;
                    const errosRotaA = parseInt(document.getElementById('errosRotaA').value) || 0;
                    const omissoesRotaA = parseInt(document.getElementById('omissoesRotaA').value) || 0;
                    const acertosRotaD = parseInt(document.getElementById('acertosRotaD').value) || 0;
                    const errosRotaD = parseInt(document.getElementById('errosRotaD').value) || 0;
                    const omissoesRotaD = parseInt(document.getElementById('omissoesRotaD').value) || 0;
                    const acertosRotaC = parseInt(document.getElementById('acertosRotaC').value) || 0;
                    const errosRotaC = parseInt(document.getElementById('errosRotaC').value) || 0;
                    const omissoesRotaC = parseInt(document.getElementById('omissoesRotaC').value) || 0;
                    const tabelaId = document.getElementById('rotasTabelaId').value ? parseInt(document.getElementById('rotasTabelaId').value) : null;

                    const body = {
                        acertos_rota_a: acertosRotaA,
                        erros_rota_a: errosRotaA,
                        omissoes_rota_a: omissoesRotaA,
                        acertos_rota_d: acertosRotaD,
                        erros_rota_d: errosRotaD,
                        omissoes_rota_d: omissoesRotaD,
                        acertos_rota_c: acertosRotaC,
                        erros_rota_c: errosRotaC,
                        omissoes_rota_c: omissoesRotaC
                    };

                    // Adicionar tabela_id apenas se foi selecionada
                    if (tabelaId) {
                        body.tabela_id = tabelaId;
                    }

                    response = await fetch(`${API_BASE}/api/rotas/calcular`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                } else if (selectedTest === 'bpa2') {
                    const acertosAlternada = parseInt(document.getElementById('acertosAlternada').value) || 0;
                    const errosAlternada = parseInt(document.getElementById('errosAlternada').value) || 0;
                    const omissoesAlternada = parseInt(document.getElementById('omissoesAlternada').value) || 0;
                    const acertosConcentrada = parseInt(document.getElementById('acertosConcentrada').value) || 0;
                    const errosConcentrada = parseInt(document.getElementById('errosConcentrada').value) || 0;
                    const omissoesConcentrada = parseInt(document.getElementById('omissoesConcentrada').value) || 0;
                    const acertosDividida = parseInt(document.getElementById('acertosDividida').value) || 0;
                    const errosDividida = parseInt(document.getElementById('errosDividida').value) || 0;
                    const omissoesDividida = parseInt(document.getElementById('omissoesDividida').value) || 0;
                    const tabelaSelect = document.getElementById('bpa2TabelaId');
                    const tabelaId = tabelaSelect.value ? parseInt(tabelaSelect.value) : null;
                    const selectedOption = tabelaSelect.options[tabelaSelect.selectedIndex];
                    const criterio = selectedOption && selectedOption.dataset ? selectedOption.dataset.criterio : null;
                    
                    // Obter idade e escolaridade selecionadas
                    const idadeSelect = document.getElementById('bpa2Idade');
                    const escolaridadeSelect = document.getElementById('bpa2Escolaridade');
                    const idade = idadeSelect ? idadeSelect.value : null;
                    const escolaridade = escolaridadeSelect ? escolaridadeSelect.value : null;
                    
                    // Determinar valor_criterio: priorizar idade, depois escolaridade, sen√£o "Amostra Total"
                    let valorCriterio = null;
                    if (idade && idade !== 'Amostra Total') {
                        valorCriterio = idade;
                    } else if (escolaridade && escolaridade !== 'Amostra Total') {
                        valorCriterio = escolaridade;
                    } else {
                        valorCriterio = 'Amostra Total';
                    }

                    const body = {
                        acertos_alternada: acertosAlternada,
                        erros_alternada: errosAlternada,
                        omissoes_alternada: omissoesAlternada,
                        acertos_concentrada: acertosConcentrada,
                        erros_concentrada: errosConcentrada,
                        omissoes_concentrada: omissoesConcentrada,
                        acertos_dividida: acertosDividida,
                        erros_dividida: errosDividida,
                        omissoes_dividida: omissoesDividida,
                        tabela_id: tabelaId,
                        criterio: criterio,
                        idade: idade,
                        escolaridade: escolaridade,
                        valor_criterio: valorCriterio
                    };

                    // Adicionar tabela_id apenas se foi selecionada
                    if (tabelaId) {
                        body.tabela_id = tabelaId;
                    }

                    response = await fetch(`${API_BASE}/api/bpa2/calcular`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                } else if (selectedTest === 'memoria') {
                    const evocacaoImediata = parseInt(document.getElementById('evocacaoImediata').value);
                    const evocacaoTardia = parseInt(document.getElementById('evocacaoTardia').value);
                    const retencao = document.getElementById('retencao').value ? parseInt(document.getElementById('retencao').value) : null;
                    const reconhecimento = document.getElementById('reconhecimento').value ? parseInt(document.getElementById('reconhecimento').value) : null;

                    response = await fetch(`${API_BASE}/api/memoria/calcular`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            evocacao_imediata: evocacaoImediata,
                            evocacao_tardia: evocacaoTardia,
                            retencao: retencao,
                            reconhecimento: reconhecimento,
                            regiao: document.getElementById('memoriaRegiao').value,
                            escolaridade: document.getElementById('memoriaEscolaridade').value,
                            idade: document.getElementById('memoriaIdade').value ? parseInt(document.getElementById('memoriaIdade').value) : null
                        })
                    });
                }

                const data = await response.json();

                if (data.success) {
                    resultadoCalculado = data.data;
                    avancarStep(4);
                    exibirResultado(data.data);
                    
                    // Mostrar aviso se houver (ex: tabela n√£o encontrada)
                    if (data.aviso) {
                        alert('‚ÑπÔ∏è ' + data.aviso);
                    }
                } else {
                    // Melhorar mensagem de erro
                    let mensagemErro = data.error || data.message || 'Erro desconhecido';
                    
                    // N√£o mostrar dica sobre tabela se o erro n√£o for de tabela obrigat√≥ria
                    if (mensagemErro.includes('tabela_id √© obrigat√≥rio') || mensagemErro.includes('tabela_id √© obrigat√≥ria')) {
                        mensagemErro += '\n\nüí° Dica: Popule as tabelas normativas primeiro usando o bot√£o "üóÑÔ∏è Todas" na p√°gina principal.';
                    } else if (mensagemErro.includes('tabela') || mensagemErro.includes('Tabela')) {
                        // Para outros erros de tabela, apenas informar que pode calcular sem
                        mensagemErro += '\n\n‚ÑπÔ∏è Nota: Voc√™ pode calcular sem tabela normativa (apenas pontos brutos).';
                    }
                    
                    alert('‚ùå Erro: ' + mensagemErro);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao calcular: ' + error.message);
            }
        }

        // Exibir resultado
        function exibirResultado(data) {
            const container = document.getElementById('resultadoContainer');
            container.innerHTML = '';

            if (selectedTest === 'ac') {
                container.innerHTML = `
                    <div class="resultBox highlight">
                        <div class="resultValue">${data.pb} pontos</div>
                        <div class="resultLabel">Pontos Brutos (PB)</div>
                    </div>
                    <div class="resultBox">
                        <strong>F√≥rmula:</strong> ${data.formula || 'P = A - (E + O)'}
                    </div>
                    ${data.percentil !== null ? `
                        <div class="resultBox">
                            <strong>Percentil:</strong> ${data.percentil}
                        </div>
                        <div class="resultBox">
                            <strong>Classifica√ß√£o:</strong> ${data.classificacao}
                        </div>
                    ` : ''}
                    <div class="resultBox">
                        <strong>Tabela Utilizada:</strong> ${data.tabela_utilizada || 'N√£o dispon√≠vel'}
                    </div>
                `;
            } else if (selectedTest === 'rotas') {
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        ${data.c ? `
                            <div class="resultBox" style="background: #e8f5e9; border-color: #4caf50;">
                                <h4 style="color: #388e3c; margin-bottom: 10px;">Rota C - Aten√ß√£o Concentrada</h4>
                                <p style="font-size: 11px; color: #666; margin-bottom: 10px;">1¬™ Aplica√ß√£o</p>
                                <div><strong>Acertos:</strong> ${data.c.acertos}</div>
                                <div><strong>Erros:</strong> ${data.c.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.c.omissoes}</div>
                                <div><strong>PB:</strong> ${data.c.pb}</div>
                                ${data.c.percentil !== null ? `
                                    <div><strong>Percentil:</strong> ${data.c.percentil}</div>
                                    <div><strong>Classifica√ß√£o:</strong> ${data.c.classificacao}</div>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${data.a ? `
                            <div class="resultBox" style="background: #e3f2fd; border-color: #2196f3;">
                                <h4 style="color: #1976d2; margin-bottom: 10px;">Rota A - Aten√ß√£o Alternada</h4>
                                <p style="font-size: 11px; color: #666; margin-bottom: 10px;">2¬™ Aplica√ß√£o</p>
                                <div><strong>Acertos:</strong> ${data.a.acertos}</div>
                                <div><strong>Erros:</strong> ${data.a.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.a.omissoes}</div>
                                <div><strong>PB:</strong> ${data.a.pb}</div>
                                ${data.a.percentil !== null ? `
                                    <div><strong>Percentil:</strong> ${data.a.percentil}</div>
                                    <div><strong>Classifica√ß√£o:</strong> ${data.a.classificacao}</div>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${data.d ? `
                            <div class="resultBox" style="background: #f3e5f5; border-color: #9c27b0;">
                                <h4 style="color: #7b1fa2; margin-bottom: 10px;">Rota D - Aten√ß√£o Dividida</h4>
                                <p style="font-size: 11px; color: #666; margin-bottom: 10px;">3¬™ Aplica√ß√£o</p>
                                <div><strong>Acertos:</strong> ${data.d.acertos}</div>
                                <div><strong>Erros:</strong> ${data.d.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.d.omissoes}</div>
                                <div><strong>PB:</strong> ${data.d.pb}</div>
                                ${data.d.percentil !== null ? `
                                    <div><strong>Percentil:</strong> ${data.d.percentil}</div>
                                    <div><strong>Classifica√ß√£o:</strong> ${data.d.classificacao}</div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
                container.innerHTML = html;
            } else if (selectedTest === 'bpa2') {
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        ${data.alternada ? `
                            <div class="resultBox" style="background: #e3f2fd; border-color: #2196f3;">
                                <h4 style="color: #1976d2; margin-bottom: 10px;">AA - Aten√ß√£o Alternada</h4>
                                <div><strong>Acertos:</strong> ${data.alternada.acertos}</div>
                                <div><strong>Erros:</strong> ${data.alternada.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.alternada.omissoes}</div>
                                <div><strong>Pontos:</strong> ${data.alternada.pontos}</div>
                                ${data.alternada.percentil !== null && data.alternada.percentil !== undefined ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Percentil:</strong> ${data.alternada.percentil}</div>
                                        <div><strong>Classifica√ß√£o:</strong> ${data.alternada.classificacao}</div>
                                    </div>
                                ` : data.alternada.classificacao && data.alternada.classificacao !== 'Tabela normativa n√£o dispon√≠vel' ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Classifica√ß√£o:</strong> ${data.alternada.classificacao}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${data.concentrada ? `
                            <div class="resultBox" style="background: #e8f5e9; border-color: #4caf50;">
                                <h4 style="color: #388e3c; margin-bottom: 10px;">AC - Aten√ß√£o Concentrada</h4>
                                <div><strong>Acertos:</strong> ${data.concentrada.acertos}</div>
                                <div><strong>Erros:</strong> ${data.concentrada.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.concentrada.omissoes}</div>
                                <div><strong>Pontos:</strong> ${data.concentrada.pontos}</div>
                                ${data.concentrada.percentil !== null && data.concentrada.percentil !== undefined ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Percentil:</strong> ${data.concentrada.percentil}</div>
                                        <div><strong>Classifica√ß√£o:</strong> ${data.concentrada.classificacao}</div>
                                    </div>
                                ` : data.concentrada.classificacao && data.concentrada.classificacao !== 'Tabela normativa n√£o dispon√≠vel' ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Classifica√ß√£o:</strong> ${data.concentrada.classificacao}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${data.dividida ? `
                            <div class="resultBox" style="background: #f3e5f5; border-color: #9c27b0;">
                                <h4 style="color: #7b1fa2; margin-bottom: 10px;">AD - Aten√ß√£o Dividida</h4>
                                <div><strong>Acertos:</strong> ${data.dividida.acertos}</div>
                                <div><strong>Erros:</strong> ${data.dividida.erros}</div>
                                <div><strong>Omiss√µes:</strong> ${data.dividida.omissoes}</div>
                                <div><strong>Pontos:</strong> ${data.dividida.pontos}</div>
                                ${data.dividida.percentil !== null && data.dividida.percentil !== undefined ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Percentil:</strong> ${data.dividida.percentil}</div>
                                        <div><strong>Classifica√ß√£o:</strong> ${data.dividida.classificacao}</div>
                                    </div>
                                ` : data.dividida.classificacao && data.dividida.classificacao !== 'Tabela normativa n√£o dispon√≠vel' ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                        <div><strong>Classifica√ß√£o:</strong> ${data.dividida.classificacao}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                    ${data.geral ? `
                        <div class="resultBox highlight" style="background: #fff3e0; border-color: #ff9800;">
                            <h4 style="color: #e65100; margin-bottom: 10px;">üìä Aten√ß√£o Geral</h4>
                            <div class="resultValue">${data.geral.pontos} pontos</div>
                            <p style="font-size: 12px; color: #666; margin: 5px 0;">Soma: AA + AC + AD</p>
                            ${data.geral.percentil !== null && data.geral.percentil !== undefined ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                    <div><strong>Percentil:</strong> ${data.geral.percentil}</div>
                                    <div><strong>Classifica√ß√£o:</strong> ${data.geral.classificacao}</div>
                                </div>
                            ` : data.geral.classificacao && data.geral.classificacao !== 'Tabela normativa n√£o dispon√≠vel' ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                                    <div><strong>Classifica√ß√£o:</strong> ${data.geral.classificacao}</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                `;
                container.innerHTML = html;
            } else if (selectedTest === 'palografico') {
                container.innerHTML = `
                    <div class="resultBox highlight">
                        <div class="resultValue">${data.produtividade} palos</div>
                        <div class="resultLabel">Produtividade (5 minutos)</div>
                    </div>
                    <div class="resultBox">
                        <strong>NOR:</strong> ${data.nor}
                        ${data.classificacoes?.nor ? ` (${data.classificacoes.nor})` : ''}
                    </div>
                    ${data.tamanho ? `
                        <div class="resultBox">
                            <strong>Tamanho M√©dio:</strong> ${data.tamanho.media} mm
                            ${data.classificacoes?.tamanho ? ` (${data.classificacoes.tamanho})` : ''}
                        </div>
                    ` : ''}
                    ${data.distancia_media ? `
                        <div class="resultBox">
                            <strong>Dist√¢ncia M√©dia:</strong> ${data.distancia_media} mm
                            ${data.classificacoes?.distancia ? ` (${data.classificacoes.distancia})` : ''}
                        </div>
                    ` : ''}
                    ${data.interpretacao ? `
                        <div class="resultBox">
                            <strong>Interpreta√ß√£o:</strong><br>
                            ${data.interpretacao.resumo_contextualizado || 'Interpreta√ß√£o dispon√≠vel'}
                        </div>
                    ` : ''}
                `;
            } else if (selectedTest === 'memoria') {
                container.innerHTML = `
                    <div class="resultBox highlight">
                        <div class="resultValue">${data.evocacao_tardia} itens</div>
                        <div class="resultLabel">Evoca√ß√£o Tardia</div>
                    </div>
                    <div class="resultBox">
                        <strong>Reten√ß√£o:</strong> ${data.retencao} itens (${data.percentual_retencao}%)
                        ${data.classificacoes?.retencao ? ` (${data.classificacoes.retencao})` : ''}
                    </div>
                    ${data.reconhecimento !== undefined ? `
                        <div class="resultBox">
                            <strong>Reconhecimento:</strong> ${data.reconhecimento} itens
                            ${data.classificacoes?.reconhecimento ? ` (${data.classificacoes.reconhecimento})` : ''}
                        </div>
                    ` : ''}
                `;
            }
        }

        // Iniciar novo teste
        function iniciarNovo() {
            currentStep = 1;
            selectedTest = null;
            resultadoCalculado = null;
            document.querySelectorAll('.testCard').forEach(c => c.classList.remove('selected'));
            document.getElementById('manualForm').style.display = 'none';
            document.getElementById('imagemForm').style.display = 'none';
            atualizarTimeline(1);
            mostrarSection(1);
        }

        // Quando teste √© selecionado, avan√ßar automaticamente
        document.querySelectorAll('.testCard').forEach(card => {
            card.addEventListener('click', () => {
                setTimeout(() => avancarStep(2), 300);
            });
        });

        // Mostrar formul√°rio manual quando avan√ßar para step 2
        const originalAvancarStep = avancarStep;
        avancarStep = function(step) {
            originalAvancarStep(step);
            if (step === 2 && inputMethod === 'manual') {
                mostrarFormManual();
            }
        };
    </script>
</body>
</html>

